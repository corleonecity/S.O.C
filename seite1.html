<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“‹ HR - Einweisungsmanagement (Dashboard + Audit + Debounce)</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary:#4f46e5; --primary-dark:#4338ca; --primary-light:#818cf8;
      --secondary:#10b981; --secondary-dark:#059669;
      --danger:#ef4444; --warning:#f59e0b;
      --dark:#111827; --dark-card:#1f2937;
      --light:#f9fafb; --gray:#9ca3af; --gray-light:#d1d5db;
      --border: rgba(255,255,255,.12);
      --shadow-lg: 0 20px 40px -10px rgba(0,0,0,.4);
      --shadow-md: 0 8px 20px -5px rgba(0,0,0,.25);
      --radius-xl:16px; --radius-lg:12px; --radius-md:8px;
      --transition: all .25s cubic-bezier(.4,0,.2,1);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Inter',sans-serif;
      background: linear-gradient(135deg,#0f172a 0%,#1e293b 100%);
      color: var(--light);
      min-height:100vh;
      overflow-x:hidden;
      font-size:14px;
    }
    .bg-effects{position:fixed;inset:0;z-index:-1;overflow:hidden;}
    .bg-gradient{
      position:absolute;inset:0;
      background:
        radial-gradient(circle at 15% 70%, rgba(79,70,229,.2) 0%, transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(16,185,129,.15) 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(99,102,241,.08) 0%, transparent 50%);
    }

    .app-container{
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:20px;
      min-height:100vh;
    }

    /* Header */
    .app-header{
      grid-column:1/-1;
      background: linear-gradient(135deg, rgba(79,70,229,.85) 0%, rgba(67,56,202,.9) 100%);
      border-radius: var(--radius-xl);
      padding: 20px 24px;
      border:1px solid var(--border);
      box-shadow: var(--shadow-lg);
      position:relative;
      overflow:hidden;
      margin-bottom: 0;
    }
    .app-header::before{
      content:'';
      position:absolute; left:0; right:0; top:0; height:3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--primary-light) 100%);
    }
    .header-content{display:flex; justify-content:space-between; align-items:flex-start; gap:16px;}
    .brand{display:flex; align-items:center; gap:16px;}
    .logo{
      width:52px;height:52px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--radius-lg);
      display:flex;align-items:center;justify-content:center;
      font-size:22px; color:white;
      box-shadow: 0 6px 18px rgba(79,70,229,.4);
      transition: var(--transition);
    }
    .brand-text h1{font-size:20px;font-weight:800;margin-bottom:4px;}
    .brand-text .subtitle{font-size:12px;color:rgba(255,255,255,.85);font-weight:600;}

    /* Dashboard KPI Row (neu) */
    .header-stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(120px, 1fr));
      gap: 12px;
      align-items: stretch;
      width: min(720px, 100%);
    }
    .stat-card{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius: var(--radius-lg);
      padding: 12px 14px;
      backdrop-filter: blur(12px);
      transition: var(--transition);
      min-height: 70px;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .stat-card .stat-top{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .stat-card i{opacity:.9;}
    .stat-value{font-size:22px;font-weight:900;margin-top:6px;}
    .stat-label{font-size:11px;text-transform:uppercase;letter-spacing:.4px;font-weight:800;color:rgba(255,255,255,.9)}
    .stat-card.danger{border-color: rgba(239,68,68,.35);}
    .stat-card.warning{border-color: rgba(245,158,11,.35);}
    .stat-card.success{border-color: rgba(16,185,129,.35);}

    /* Optional: Save-Indicator (neu) */
    .save-indicator{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      align-items:center;
      color: rgba(255,255,255,.9);
      font-weight:700;
      font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.15);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill.ok{border-color: rgba(16,185,129,.35);}
    .pill.dirty{border-color: rgba(245,158,11,.35);}
    .pill.saving{border-color: rgba(79,70,229,.45);}

    /* Layout Panels */
    .sidebar{
      background: rgba(31,41,55,.92);
      border-radius: var(--radius-xl);
      padding: 20px;
      border:1px solid var(--border);
      box-shadow: var(--shadow-md);
      height: fit-content;
      position: sticky;
      top: 20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .main-content{
      background: rgba(31,41,55,.92);
      border-radius: var(--radius-xl);
      border:1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 620px;
    }

    /* Sidebar controls */
    .sidebar-header{display:flex;justify-content:space-between;align-items:center;}
    .sidebar-title{
      font-size:15px;font-weight:900;color: var(--primary-light);
      text-transform:uppercase;letter-spacing:.4px;
      display:flex; align-items:center; gap:10px;
    }
    .employee-count{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 5px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
      box-shadow: 0 3px 10px rgba(79,70,229,.25);
    }
    .sidebar-filter-buttons{display:flex;gap:8px;}
    .sidebar-filter-btn{
      flex:1;
      padding:8px 12px;
      border-radius: var(--radius-md);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: var(--gray-light);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: var(--transition);
    }
    .sidebar-filter-btn.active{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-color: var(--primary);
      color:white;
    }
    .search-container{position:relative;}
    .search-input{
      width:100%;
      padding: 12px 16px 12px 42px;
      border-radius: var(--radius-md);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:white;
      outline:none;
    }
    .search-icon{
      position:absolute;left:16px;top:50%;transform:translateY(-50%);
      color: var(--primary-light);
    }

    .employee-list{
      display:flex;flex-direction:column;gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right: 6px;
    }
    .employee-card{
      background: linear-gradient(135deg, rgba(79,70,229,.12) 0%, rgba(31,41,55,.3) 100%);
      border:1px solid transparent;
      border-radius: var(--radius-md);
      padding: 14px;
      cursor:pointer;
      transition: var(--transition);
      position:relative;
      overflow:hidden;
      min-height: 104px;
    }
    .employee-card:hover{border-color: var(--primary); transform: translateX(3px);}
    .employee-card.active{border-color: var(--primary); box-shadow: 0 6px 20px rgba(79,70,229,.2);}
    .employee-card::before{content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--primary);}
    .employee-card.active::before{background: var(--secondary);}
    .employee-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
    .employee-name{font-weight:900;font-size:15px;}
    .employee-dn{
      font-family: 'Courier New', monospace;
      font-size:12px;font-weight:900;
      color: var(--primary-light);
      background: rgba(79,70,229,.15);
      border:1px solid rgba(79,70,229,.25);
      padding: 4px 10px;
      border-radius: 10px;
      white-space:nowrap;
    }
    .employee-meta{color: var(--gray-light); font-size:12px; display:flex; flex-direction:column; gap:4px; margin-bottom:10px;}
    .badges{display:flex;gap:6px;flex-wrap:wrap;}
    .badge{
      font-size:11px;font-weight:900;
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      display:inline-flex; gap:6px; align-items:center;
      white-space:nowrap;
    }
    .badge.pending{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.25); color:#fecaca;}
    .badge.done{background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.25); color:#bbf7d0;}
    .badge.overdue{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.25); color:#fde68a;}

    .quick-action-btn{
      padding: 12px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, rgba(79,70,229,.12) 0%, rgba(67,56,202,.15) 100%);
      border: 1px solid rgba(79,70,229,.2);
      color: var(--primary-light);
      cursor:pointer;
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: var(--transition);
    }
    .quick-action-btn:hover{border-color: var(--primary); color:white; transform: translateY(-2px);}

    /* Main content header */
    .content-header{
      padding: 18px 22px;
      background: linear-gradient(135deg, rgba(79,70,229,.12) 0%, rgba(31,41,55,.3) 100%);
      border-bottom:1px solid var(--border);
      display:none;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }
    .employee-info h2{font-size:20px;font-weight:900;margin-bottom:10px;}
    .employee-tags{display:flex;gap:10px;flex-wrap:wrap;}
    .tag{
      display:flex;align-items:center;gap:8px;
      font-size:12px;font-weight:800;
      color: var(--gray-light);
    }
    .tag .tag-value{
      color:white;
      background: rgba(79,70,229,.2);
      border:1px solid rgba(79,70,229,.3);
      padding: 4px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }

    /* Tabs (neu: Details / Audit) */
    .tabs{
      display:none;
      padding: 12px 22px;
      border-bottom:1px solid var(--border);
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .tab-btn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      color: rgba(255,255,255,.85);
      background: rgba(255,255,255,.08);
      transition: var(--transition);
      display:inline-flex; gap:8px; align-items:center;
    }
    .tab-btn.active{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color:white;
    }

    /* Sections */
    .panel{
      display:none;
      padding: 22px;
      overflow:auto;
      flex:1;
    }

    /* Notification */
    .notification{
      position: fixed;
      bottom:24px; right:24px;
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color:white;
      padding: 14px 18px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display:flex; gap:10px; align-items:center;
      z-index:1001;
      transform: translateY(100px);
      opacity:0;
      transition: transform .3s ease, opacity .3s ease;
      min-width: 260px;
    }
    .notification.show{transform: translateY(0); opacity:1;}

    /* Simple form styling */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
    .form-group{display:flex;flex-direction:column;gap:8px;}
    .form-label{font-weight:900;font-size:12px;text-transform:uppercase;letter-spacing:.4px;color: var(--gray-light);}
    .form-input,.form-select,.form-textarea{
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:white;
      outline:none;
    }
    .form-textarea{min-height:90px; resize:vertical; font-family:'Inter',sans-serif;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    .btn{
      border:none; cursor:pointer;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      font-weight:900;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      transition: var(--transition);
      font-size: 13px;
    }
    .btn-primary{background: linear-gradient(135deg,var(--primary) 0%, var(--primary-dark) 100%); color:white;}
    .btn-secondary{background: rgba(255,255,255,.12); color:white; border:1px solid rgba(255,255,255,.18);}
    .btn-danger{background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); color:white;}
    .btn-success{background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); color:white;}

    /* Audit list */
    .audit-list{display:flex;flex-direction:column;gap:10px;}
    .audit-item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius-md);
      padding: 12px 14px;
    }
    .audit-top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .audit-event{font-weight:900;}
    .audit-meta{color: rgba(255,255,255,.75); font-size:12px; font-weight:700;}
    .audit-changes{margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color: var(--gray-light); white-space:pre-wrap;}

    @media (max-width: 1200px){
      .app-container{grid-template-columns:1fr;}
      .sidebar{position:static;}
      .header-stats{grid-template-columns: repeat(2, minmax(120px, 1fr));}
    }
    @media (max-width: 640px){
      .header-content{flex-direction:column; align-items:stretch;}
      .header-stats{grid-template-columns: 1fr 1fr;}
      .grid-2,.grid-3{grid-template-columns:1fr;}
      .notification{left:12px; right:12px; bottom:12px; min-width:auto;}
    }
  </style>
</head>

<body>
  <div class="bg-effects"><div class="bg-gradient"></div></div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <i class="fas fa-check"></i>
    <span id="notificationMessage" style="font-weight:900;"></span>
  </div>

  <div class="app-container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-content">
        <div class="brand">
          <div class="logo"><i class="fas fa-user-check"></i></div>
          <div class="brand-text">
            <h1>Human Resources</h1>
            <div class="subtitle">Dashboard â€¢ Einweisungen â€¢ Audit Log â€¢ Debounced Autosave</div>
          </div>
        </div>

        <!-- KPI DASHBOARD (neu) -->
        <div class="header-stats">
          <div class="stat-card" id="kpiTotal">
            <div class="stat-top">
              <div class="stat-label">Mitarbeiter</div>
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-value" id="totalEmployees">0</div>
          </div>

          <div class="stat-card danger" id="kpiOralPending">
            <div class="stat-top">
              <div class="stat-label">MÃ¼ndlich ausstehend</div>
              <i class="fas fa-comments"></i>
            </div>
            <div class="stat-value" id="pendingOral">0</div>
          </div>

          <div class="stat-card danger" id="kpiOrgPending">
            <div class="stat-top">
              <div class="stat-label">Org ausstehend</div>
              <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-value" id="pendingOrg">0</div>
          </div>

          <div class="stat-card success" id="kpiAvgDays">
            <div class="stat-top">
              <div class="stat-label">Ã˜ Tage bis Abschluss</div>
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value" id="avgDaysToComplete">â€“</div>
          </div>
        </div>
      </div>

      <!-- Save indicator (neu) -->
      <div class="save-indicator">
        <span class="pill ok" id="savePill">
          <i class="fas fa-circle-check"></i>
          <span id="savePillText">Gespeichert</span>
        </span>
        <button class="btn btn-secondary" id="btnSaveNow" style="display:none;">
          <i class="fas fa-save"></i> Jetzt speichern
        </button>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title"><i class="fas fa-users"></i> Mitarbeiter</div>
        <div class="employee-count" id="employeeCount">0</div>
      </div>

      <div class="sidebar-filter-buttons">
        <button class="sidebar-filter-btn active" data-filter="all">Alle</button>
        <button class="sidebar-filter-btn" data-filter="oral">MÃ¼ndlich</button>
        <button class="sidebar-filter-btn" data-filter="org">Org</button>
      </div>

      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input class="search-input" id="searchEmployees" placeholder="Nach Namen oder DN suchen..."/>
      </div>

      <div class="employee-list" id="employeeList"></div>

      <button class="quick-action-btn" id="btnNewEmployee">
        <i class="fas fa-user-plus"></i> Neuer Mitarbeiter
      </button>
    </aside>

    <!-- MAIN -->
    <main class="main-content">

      <!-- Employee Header -->
      <div class="content-header" id="employeeHeader">
        <div class="employee-info">
          <h2 id="currentEmployeeName">WÃ¤hlen Sie einen Mitarbeiter</h2>
          <div class="employee-tags">
            <div class="tag"><i class="fas fa-hashtag"></i> <span class="tag-value" id="currentEmployeeDN">DN-</span></div>
            <div class="tag"><i class="fas fa-building"></i> <span class="tag-value" id="currentEmployeeUnit">Unit</span></div>
            <div class="tag"><i class="fas fa-user-tie"></i> <span class="tag-value" id="currentEmployeeRank">Rang</span></div>
            <div class="tag"><i class="fas fa-flag"></i> <span class="tag-value" id="currentEmployeeStatus">active</span></div>
          </div>
        </div>

        <div class="row">
          <button class="btn btn-secondary" id="btnEditEmployee"><i class="fas fa-edit"></i> Bearbeiten</button>
          <button class="btn btn-secondary" id="btnCopyBoth"><i class="fas fa-copy"></i> Beide kopieren</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="tabDetails"><i class="fas fa-id-card"></i> Details</button>
        <button class="tab-btn" data-tab="tabAudit"><i class="fas fa-clock-rotate-left"></i> Audit</button>
        <button class="tab-btn" data-tab="tabInsights"><i class="fas fa-chart-pie"></i> Insights</button>
      </div>

      <!-- Panels -->
      <section class="panel" id="tabDetails">
        <!-- kommt in Teil 2/4 -->
      </section>

      <section class="panel" id="tabAudit">
        <!-- kommt in Teil 2/4 -->
      </section>

      <section class="panel" id="tabInsights">
        <!-- kommt in Teil 2/4 -->
      </section>

    </main>
  </div>

<!-- =========================
     TAB: DETAILS
========================== -->
<section class="panel" id="tabDetails">

  <!-- HR Meta (neu) -->
  <div style="margin-bottom:18px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center;">
      <i class="fas fa-clipboard-check" style="color: var(--primary-light);"></i>
      Einweisungen & HR-Metadaten
    </div>
    <div class="row">
      <button class="btn btn-secondary" id="btnMarkDirtyTest" title="Optional: Testbutton, kann entfernt werden" style="display:none;">
        <i class="fas fa-wand-magic-sparkles"></i> Dirty
      </button>
      <button class="btn btn-success" id="btnCompleteBoth">
        <i class="fas fa-check-double"></i> Beide auf â€žbestandenâ€œ
      </button>
    </div>
  </div>

  <!-- Meta Grid -->
  <div class="grid-3" style="margin-bottom:18px;">
    <div class="form-group">
      <label class="form-label">Eintritt / StartDate</label>
      <input type="date" class="form-input" id="startDate"/>
    </div>

    <div class="form-group">
      <label class="form-label">Status</label>
      <select class="form-select" id="statusSelect">
        <option value="active">active</option>
        <option value="on-hold">on-hold</option>
        <option value="left">left</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Tags (Komma-getrennt)</label>
      <input type="text" class="form-input" id="tagsInput" placeholder="recruit, transfer, re-entry"/>
    </div>
  </div>

  <div class="grid-2" style="margin-bottom:18px;">
    <div class="form-group">
      <label class="form-label">Supervisor (Name / DN)</label>
      <input type="text" class="form-input" id="supervisorInput" placeholder="z.B. Nico Kickl / 12"/>
    </div>

    <div class="form-group">
      <label class="form-label">Mentor (Name / DN)</label>
      <input type="text" class="form-input" id="mentorInput" placeholder="z.B. Anna Schmidt / 25"/>
    </div>
  </div>

  <div class="form-group" style="margin-bottom:22px;">
    <label class="form-label">Interne Notizen (nicht im Discord Template)</label>
    <textarea class="form-textarea" id="notesInternal" placeholder="Nur intern..."></textarea>
  </div>

  <!-- Einweisungen -->
  <div class="grid-2" style="margin-bottom:22px;">

    <!-- MÃ¼ndlich -->
    <div style="border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);" id="cardOral">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px;">
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center;
                      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
            <i class="fas fa-comments"></i>
          </div>
          <div>
            <div style="font-weight:900;">MÃ¼ndliche Einweisung</div>
            <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:700;">Status: <span id="oralStatusText">AUSSTEHEND</span></div>
          </div>
        </div>
        <button class="btn btn-secondary" id="btnToggleOral">
          <i class="fas fa-toggle-off"></i> Toggle
        </button>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">PrÃ¼fer</label>
          <input class="form-input" id="oralExaminer" placeholder="Name des PrÃ¼fers"/>
        </div>
        <div class="form-group">
          <label class="form-label">Datum</label>
          <input type="date" class="form-input" id="oralDate"/>
        </div>
        <div class="form-group">
          <label class="form-label">Start</label>
          <input type="time" class="form-input" id="oralTimeStart"/>
        </div>
        <div class="form-group">
          <label class="form-label">Ende</label>
          <input type="time" class="form-input" id="oralTimeEnd"/>
        </div>
        <div class="form-group">
          <label class="form-label">Beteiligte</label>
          <input class="form-input" id="oralPerson" placeholder="Name der beteiligten Person"/>
        </div>
        <div class="form-group">
          <label class="form-label">Sonstiges</label>
          <input class="form-input" id="oralNotes" placeholder="Kurznotiz (optional)"/>
        </div>
      </div>

      <div style="margin-top:12px; color: rgba(255,255,255,.75); font-size:12px; font-weight:700;">
        CompletedAt: <span id="oralCompletedAt">â€“</span>
      </div>
    </div>

    <!-- Organisatorisch -->
    <div style="border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);" id="cardOrg">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px;">
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center;
                      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div>
            <div style="font-weight:900;">Organisatorische Einweisung</div>
            <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:700;">Status: <span id="orgStatusText">AUSSTEHEND</span></div>
          </div>
        </div>
        <button class="btn btn-secondary" id="btnToggleOrg">
          <i class="fas fa-toggle-off"></i> Toggle
        </button>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">PrÃ¼fer</label>
          <input class="form-input" id="orgExaminer" placeholder="Name des PrÃ¼fers"/>
        </div>
        <div class="form-group">
          <label class="form-label">Datum</label>
          <input type="date" class="form-input" id="orgDate"/>
        </div>
        <div class="form-group">
          <label class="form-label">Start</label>
          <input type="time" class="form-input" id="orgTimeStart"/>
        </div>
        <div class="form-group">
          <label class="form-label">Ende</label>
          <input type="time" class="form-input" id="orgTimeEnd"/>
        </div>
        <div class="form-group">
          <label class="form-label">Beteiligte</label>
          <input class="form-input" id="orgPerson" placeholder="Name der beteiligten Person"/>
        </div>
        <div class="form-group">
          <label class="form-label">Sonstiges</label>
          <input class="form-input" id="orgNotes" placeholder="Kurznotiz (optional)"/>
        </div>
      </div>

      <div style="margin-top:12px; color: rgba(255,255,255,.75); font-size:12px; font-weight:700;">
        CompletedAt: <span id="orgCompletedAt">â€“</span>
      </div>
    </div>
  </div>

  <!-- Templates / Copy -->
  <div style="border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
      <div style="font-weight:900; display:flex; gap:10px; align-items:center;">
        <i class="fas fa-file-code" style="color: var(--primary-light);"></i> Discord Vorlagen
      </div>
      <div class="row">
        <button class="btn btn-secondary" id="btnCopyOral"><i class="fas fa-comments"></i> MÃ¼ndlich</button>
        <button class="btn btn-secondary" id="btnCopyOrg"><i class="fas fa-clipboard-list"></i> Organisatorisch</button>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <div style="font-weight:900; font-size:13px; margin-bottom:8px;">MÃ¼ndlich</div>
        <pre id="tplOral" style="margin:0; padding:12px; border-radius:12px; background: rgba(0,0,0,.35); border-left:4px solid var(--primary); max-height:220px; overflow:auto; white-space:pre-wrap; font-size:12px; color: var(--gray-light);"></pre>
      </div>
      <div>
        <div style="font-weight:900; font-size:13px; margin-bottom:8px;">Organisatorisch</div>
        <pre id="tplOrg" style="margin:0; padding:12px; border-radius:12px; background: rgba(0,0,0,.35); border-left:4px solid var(--primary); max-height:220px; overflow:auto; white-space:pre-wrap; font-size:12px; color: var(--gray-light);"></pre>
      </div>
    </div>
  </div>
</section>

<!-- =========================
     TAB: AUDIT
========================== -->
<section class="panel" id="tabAudit">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:14px;">
    <div style="font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center;">
      <i class="fas fa-clock-rotate-left" style="color: var(--primary-light);"></i>
      Audit Log (letzte 50)
    </div>
    <button class="btn btn-secondary" id="btnReloadAudit"><i class="fas fa-rotate"></i> Neu laden</button>
  </div>

  <div class="audit-list" id="auditList">
    <div style="color: var(--gray); font-weight:800;">Kein Mitarbeiter ausgewÃ¤hlt.</div>
  </div>
</section>

<!-- =========================
     TAB: INSIGHTS
========================== -->
<section class="panel" id="tabInsights">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:14px;">
    <div style="font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center;">
      <i class="fas fa-chart-pie" style="color: var(--primary-light);"></i>
      Insights (Live aus employees[])
    </div>
    <div style="color: rgba(255,255,255,.75); font-weight:700; font-size:12px;">
      Hinweis: FÃ¼r â€žletzte 30 Tageâ€œ brÃ¤uchtest du Filter auf completedAt.
    </div>
  </div>

  <div class="grid-2">
    <!-- Top PrÃ¼fer -->
    <div style="border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);">
      <div style="font-weight:900; margin-bottom:10px; display:flex; gap:10px; align-items:center;">
        <i class="fas fa-user-tie" style="color: var(--primary-light);"></i> Top PrÃ¼fer (Anzahl)
      </div>
      <div id="topExaminers" style="display:flex; flex-direction:column; gap:8px; color: var(--gray-light); font-weight:800;"></div>
    </div>

    <!-- Unit Verteilung -->
    <div style="border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);">
      <div style="font-weight:900; margin-bottom:10px; display:flex; gap:10px; align-items:center;">
        <i class="fas fa-building" style="color: var(--primary-light);"></i> Unit-Verteilung
      </div>
      <div id="unitDistribution" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>

  <!-- Optional: Overdue Liste (Beispiel) -->
  <div style="margin-top:16px; border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-lg); padding:16px; background: rgba(0,0,0,.16);">
    <div style="font-weight:900; margin-bottom:10px; display:flex; gap:10px; align-items:center;">
      <i class="fas fa-triangle-exclamation" style="color: var(--warning);"></i> ÃœberfÃ¤llig (Beispiel-Logik)
    </div>
    <div style="color: rgba(255,255,255,.75); font-weight:700; font-size:12px; margin-bottom:10px;">
      â€žÃœberfÃ¤lligâ€œ = startDate + 7 Tage und mindestens eine Einweisung noch ausstehend.
    </div>
    <div id="overdueList" style="display:flex; flex-direction:column; gap:8px; color: var(--gray-light); font-weight:800;"></div>
  </div>
</section>

<!-- =========================
     MODAL: NEW EMPLOYEE
========================== -->
<div class="modal-overlay" id="newEmployeeModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,.85); backdrop-filter: blur(8px); z-index:1000; align-items:center; justify-content:center; padding:16px;">
  <div class="modal" style="background: linear-gradient(135deg, rgba(31,41,55,.96) 0%, rgba(79,70,229,.9) 100%); border-radius: 16px; padding: 22px; width:100%; max-width: 520px; border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow-lg);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <div style="font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center;">
        <i class="fas fa-user-plus"></i> Neuen Mitarbeiter hinzufÃ¼gen
      </div>
      <button class="btn btn-secondary" id="btnCloseNewModal"><i class="fas fa-xmark"></i></button>
    </div>

    <div class="grid-2" style="margin-bottom:14px;">
      <div class="form-group">
        <label class="form-label">VollstÃ¤ndiger Name *</label>
        <input class="form-input" id="newEmployeeName" placeholder="z.B. Max Fiart"/>
      </div>
      <div class="form-group">
        <label class="form-label">Dienstnummer (DN) *</label>
        <input type="number" class="form-input" id="newEmployeeDN" placeholder="z.B. 43" min="1" max="9999"/>
      </div>
      <div class="form-group">
        <label class="form-label">Unit</label>
        <input class="form-input" id="newEmployeeUnit" placeholder="z.B. Air Force"/>
      </div>
      <div class="form-group">
        <label class="form-label">Rang</label>
        <input class="form-input" id="newEmployeeRank" placeholder="z.B. Captain"/>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:14px;">
      <div class="form-group">
        <label class="form-label">StartDate</label>
        <input type="date" class="form-input" id="newEmployeeStartDate"/>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="newEmployeeStatus">
          <option value="active">active</option>
          <option value="on-hold">on-hold</option>
          <option value="left">left</option>
        </select>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;">
      <button class="btn btn-secondary" id="btnCancelNew">Abbrechen</button>
      <button class="btn btn-primary" id="btnCreateNew"><i class="fas fa-plus"></i> Erstellen</button>
    </div>
  </div>
</div>

<!-- =========================
     MODAL: EDIT EMPLOYEE
========================== -->
<div class="modal-overlay" id="editEmployeeModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,.85); backdrop-filter: blur(8px); z-index:1000; align-items:center; justify-content:center; padding:16px;">
  <div class="modal" style="background: linear-gradient(135deg, rgba(31,41,55,.96) 0%, rgba(79,70,229,.9) 100%); border-radius: 16px; padding: 22px; width:100%; max-width: 560px; border:1px solid rgba(255,255,255,.12); box-shadow: var(--shadow-lg);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <div style="font-weight:900; font-size:16px; display:flex; gap:10px; align-items:center;">
        <i class="fas fa-pen-to-square"></i> Mitarbeiter bearbeiten
      </div>
      <button class="btn btn-secondary" id="btnCloseEditModal"><i class="fas fa-xmark"></i></button>
    </div>

    <div class="grid-2" style="margin-bottom:14px;">
      <div class="form-group">
        <label class="form-label">Name *</label>
        <input class="form-input" id="editEmployeeName"/>
      </div>
      <div class="form-group">
        <label class="form-label">DN *</label>
        <input type="number" class="form-input" id="editEmployeeDN" min="1" max="9999"/>
      </div>
      <div class="form-group">
        <label class="form-label">Unit</label>
        <input class="form-input" id="editEmployeeUnit"/>
      </div>
      <div class="form-group">
        <label class="form-label">Rang</label>
        <input class="form-input" id="editEmployeeRank"/>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:14px;">
      <div class="form-group">
        <label class="form-label">StartDate</label>
        <input type="date" class="form-input" id="editEmployeeStartDate"/>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="editEmployeeStatus">
          <option value="active">active</option>
          <option value="on-hold">on-hold</option>
          <option value="left">left</option>
        </select>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;">
      <button class="btn btn-danger" id="btnDeleteEmployee"><i class="fas fa-trash"></i> LÃ¶schen</button>
      <div class="row">
        <button class="btn btn-secondary" id="btnCancelEdit">Abbrechen</button>
        <button class="btn btn-primary" id="btnSaveEdit"><i class="fas fa-save"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<script>
  /***********************
   * 1) Firebase Config
   ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyBTnsLNw68UuOd5Xa2ymMffWk4SYGDQjso",
    authDomain: "cc-shop-finanzsystem.firebaseapp.com",
    projectId: "cc-shop-finanzsystem",
    storageBucket: "cc-shop-finanzsystem.firebasestorage.app",
    messagingSenderId: "575918945925",
    appId: "1:575918945925:web:bf9d973d5cd9fc547e5bec",
    measurementId: "G-9SZREFTJS6"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /***********************
   * 2) App State
   ***********************/
  let employees = [];
  let currentEmployee = null;
  let currentFilter = "all";

  // Autosave / Audit / UI (Debounce & Logging kommt in Teil 4/4)
  let isDirty = false;
  let isSaving = false;

  /***********************
   * 3) Helpers
   ***********************/
  const $ = (id) => document.getElementById(id);

  function showNotification(message, type = "success") {
    const n = $("notification");
    const m = $("notificationMessage");
    m.textContent = message;

    if (type === "success") n.style.background = "linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%)";
    if (type === "error") n.style.background = "linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)";
    if (type === "warning") n.style.background = "linear-gradient(135deg, var(--warning) 0%, #d97706 100%)";
    if (type === "info") n.style.background = "linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)";

    n.classList.add("show");
    setTimeout(() => n.classList.remove("show"), 2800);
  }

  function isoToday() {
    return new Date().toISOString().split("T")[0];
  }

  function formatDateTime(ts) {
    if (!ts) return "â€“";
    const d = (typeof ts === "string") ? new Date(ts) : ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("de-DE");
  }

  function safeUpper(s) {
    return (s || "").toString().toUpperCase();
  }

  function parseNameDn(input) {
    // "Nico Kickl / 12" -> {name:"Nico Kickl", dn:"12"}
    const raw = (input || "").trim();
    if (!raw) return null;
    const parts = raw.split("/").map(x => x.trim());
    if (parts.length === 1) return { name: parts[0], dn: "" };
    return { name: parts[0], dn: parts[1] || "" };
  }

  function tagsToArray(str) {
    return (str || "")
      .split(",")
      .map(t => t.trim())
      .filter(Boolean);
  }

  function arrayToTags(arr) {
    return Array.isArray(arr) ? arr.join(", ") : "";
  }

  function daysBetween(aISO, bISO) {
    if (!aISO || !bISO) return null;
    const a = new Date(aISO);
    const b = new Date(bISO);
    const ms = b.getTime() - a.getTime();
    if (Number.isNaN(ms)) return null;
    return Math.round(ms / (1000 * 60 * 60 * 24));
  }

  function isOverdue(employee, days = 7) {
    // overdue if startDate + days < today and at least one induction pending
    const sd = employee.startDate;
    if (!sd) return false;
    const oralDone = !!employee.inductions?.oral?.completed;
    const orgDone = !!employee.inductions?.org?.completed;
    if (oralDone && orgDone) return false;

    const due = new Date(sd);
    due.setDate(due.getDate() + days);

    return new Date() > due;
  }

  /***********************
   * 4) Firestore CRUD
   ***********************/
  async function loadEmployees() {
    try {
      // newest first
      const snap = await db.collection("hrEmployees").orderBy("lastUpdated", "desc").get();
      employees = [];
      snap.forEach(doc => employees.push({ id: doc.id, ...doc.data() }));

      renderEmployeeList();
      updateDashboardAndInsights();
    } catch (e) {
      console.error(e);
      showNotification("Fehler beim Laden (Firestore). PrÃ¼fe Rules/Netz.", "error");
      // Fallback leer
      employees = [];
      renderEmployeeList();
      updateDashboardAndInsights();
    }
  }

  async function saveEmployeeToFirestore(employee) {
    const payload = {
      name: employee.name || "",
      dn: employee.dn || "",
      unit: employee.unit || "",
      rank: employee.rank || "",
      startDate: employee.startDate || "",
      status: employee.status || "active",
      supervisor: employee.supervisor || null,
      mentor: employee.mentor || null,
      tags: Array.isArray(employee.tags) ? employee.tags : [],
      notesInternal: employee.notesInternal || "",

      inductions: employee.inductions || {},
      oralData: employee.oralData || {},
      orgData: employee.orgData || {},

      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("hrEmployees").doc(employee.id).set(payload, { merge: true });
  }

  async function deleteEmployeeFromFirestore(employeeId) {
    await db.collection("hrEmployees").doc(employeeId).delete();
  }

  /***********************
   * 5) Rendering: Sidebar list
   ***********************/
  function getFilteredEmployees() {
    if (currentFilter === "oral") {
      return employees.filter(e => !e.inductions?.oral?.completed);
    }
    if (currentFilter === "org") {
      return employees.filter(e => !e.inductions?.org?.completed);
    }
    return employees;
  }

  function renderEmployeeList() {
    const list = $("employeeList");
    const count = $("employeeCount");

    const filtered = getFilteredEmployees().slice().sort((a,b) => {
      const A = safeUpper(a.name);
      const B = safeUpper(b.name);
      return A < B ? -1 : A > B ? 1 : 0;
    });

    count.textContent = String(filtered.length);

    if (filtered.length === 0) {
      list.innerHTML = `<div style="padding:22px; color: var(--gray); font-weight:900;">
        Keine Mitarbeiter im aktuellen Filter.
      </div>`;
      return;
    }

    list.innerHTML = "";
    filtered.forEach(emp => {
      const oralDone = !!emp.inductions?.oral?.completed;
      const orgDone  = !!emp.inductions?.org?.completed;
      const overdue = isOverdue(emp, 7);

      const card = document.createElement("div");
      card.className = "employee-card" + (currentEmployee?.id === emp.id ? " active" : "");
      card.addEventListener("click", () => selectEmployee(emp.id));

      card.innerHTML = `
        <div class="employee-header">
          <div class="employee-name">${emp.name || "(ohne Name)"}</div>
          <div class="employee-dn">${emp.dn || "-"}</div>
        </div>
        <div class="employee-meta">
          <div>${emp.rank || "Kein Rang"}</div>
          <div>${emp.unit || "Keine Unit"}</div>
        </div>
        <div class="badges">
          <span class="badge ${oralDone ? "done" : "pending"}">
            <i class="fas ${oralDone ? "fa-check-circle" : "fa-clock"}"></i> MÃ¼ndlich
          </span>
          <span class="badge ${orgDone ? "done" : "pending"}">
            <i class="fas ${orgDone ? "fa-check-circle" : "fa-clock"}"></i> Org
          </span>
          ${overdue ? `<span class="badge overdue"><i class="fas fa-triangle-exclamation"></i> Overdue</span>` : ""}
        </div>
      `;
      list.appendChild(card);
    });
  }

  /***********************
   * 6) Employee selection + header + tabs
   ***********************/
  function selectEmployee(employeeId) {
    const emp = employees.find(e => e.id === employeeId);
    if (!emp) return;

    currentEmployee = emp;

    $("employeeHeader").style.display = "flex";
    $("tabs").style.display = "flex";
    $("tabDetails").style.display = "block";
    $("tabAudit").style.display = "none";
    $("tabInsights").style.display = "none";

    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelector(`.tab-btn[data-tab="tabDetails"]`)?.classList.add("active");

    updateEmployeeHeader();
    renderEmployeeList(); // active highlight
    loadEmployeeIntoForm();
    updateTemplates();
    // Audit wird in Teil 4/4 dynamisch geladen
    setDirty(false);
  }

  function updateEmployeeHeader() {
    if (!currentEmployee) return;
    $("currentEmployeeName").textContent = currentEmployee.name || "â€”";
    $("currentEmployeeDN").textContent = currentEmployee.dn || "â€”";
    $("currentEmployeeUnit").textContent = currentEmployee.unit || "Keine Unit";
    $("currentEmployeeRank").textContent = currentEmployee.rank || "Kein Rang";
    $("currentEmployeeStatus").textContent = currentEmployee.status || "active";
  }

  function switchTab(tabId) {
    ["tabDetails", "tabAudit", "tabInsights"].forEach(id => $(id).style.display = (id === tabId ? "block" : "none"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
  }

  /***********************
   * 7) Form load/save (Core)
   ***********************/
  function loadEmployeeIntoForm() {
    if (!currentEmployee) return;

    // Defaults
    $("oralDate").value = currentEmployee.oralData?.date || isoToday();
    $("orgDate").value  = currentEmployee.orgData?.date  || isoToday();

    $("oralTimeStart").value = currentEmployee.oralData?.timeStart || "16:40";
    $("oralTimeEnd").value   = currentEmployee.oralData?.timeEnd   || "18:00";
    $("orgTimeStart").value  = currentEmployee.orgData?.timeStart  || "22:10";
    $("orgTimeEnd").value    = currentEmployee.orgData?.timeEnd    || "23:05";

    // HR meta
    $("startDate").value = currentEmployee.startDate || "";
    $("statusSelect").value = currentEmployee.status || "active";
    $("tagsInput").value = arrayToTags(currentEmployee.tags);
    $("supervisorInput").value = currentEmployee.supervisor ? `${currentEmployee.supervisor.name || ""}${currentEmployee.supervisor.dn ? " / " + currentEmployee.supervisor.dn : ""}` : "";
    $("mentorInput").value = currentEmployee.mentor ? `${currentEmployee.mentor.name || ""}${currentEmployee.mentor.dn ? " / " + currentEmployee.mentor.dn : ""}` : "";
    $("notesInternal").value = currentEmployee.notesInternal || "";

    // Oral fields
    $("oralExaminer").value = currentEmployee.oralData?.examiner || "";
    $("oralPerson").value = currentEmployee.oralData?.person || "";
    $("oralNotes").value = currentEmployee.oralData?.notes || "";

    // Org fields
    $("orgExaminer").value = currentEmployee.orgData?.examiner || "";
    $("orgPerson").value = currentEmployee.orgData?.person || "";
    $("orgNotes").value = currentEmployee.orgData?.notes || "";

    // Status text
    updateInductionStatusText();
  }

  function readFormIntoEmployee() {
    if (!currentEmployee) return;

    // HR meta
    currentEmployee.startDate = $("startDate").value || "";
    currentEmployee.status = $("statusSelect").value || "active";
    currentEmployee.tags = tagsToArray($("tagsInput").value);
    currentEmployee.supervisor = parseNameDn($("supervisorInput").value);
    currentEmployee.mentor = parseNameDn($("mentorInput").value);
    currentEmployee.notesInternal = $("notesInternal").value || "";

    // Oral data
    currentEmployee.oralData = {
      examiner: $("oralExaminer").value || "",
      date: $("oralDate").value || "",
      timeStart: $("oralTimeStart").value || "",
      timeEnd: $("oralTimeEnd").value || "",
      person: $("oralPerson").value || "",
      notes: $("oralNotes").value || ""
    };

    // Org data
    currentEmployee.orgData = {
      examiner: $("orgExaminer").value || "",
      date: $("orgDate").value || "",
      timeStart: $("orgTimeStart").value || "",
      timeEnd: $("orgTimeEnd").value || "",
      person: $("orgPerson").value || "",
      notes: $("orgNotes").value || ""
    };
  }

  /***********************
   * 8) Induction toggles
   ***********************/
  function setInduction(type, completed) {
    if (!currentEmployee) return;
    if (!currentEmployee.inductions) currentEmployee.inductions = {};
    if (!currentEmployee.inductions[type]) currentEmployee.inductions[type] = {};

    const path = currentEmployee.inductions[type];

    path.completed = !!completed;

    // completedAt / cleared
    if (completed) {
      // prefer date+time if present, else now ISO
      const date = (type === "oral") ? $("oralDate").value : $("orgDate").value;
      const time = (type === "oral") ? $("oralTimeStart").value : $("orgTimeStart").value;
      const isoGuess = date ? new Date(date + "T" + (time || "00:00")).toISOString() : new Date().toISOString();
      path.completedAt = isoGuess;
    } else {
      path.completedAt = null;
    }

    // examiner snapshot on induction level
    const examiner = (type === "oral") ? ($("oralExaminer").value || "") : ($("orgExaminer").value || "");
    path.examiner = examiner;

    updateInductionStatusText();
    updateTemplates();
    updateDashboardAndInsights();
    renderEmployeeList();

    // Mark dirty, actual save + audit logging in Teil 4/4
    setDirty(true);
    scheduleAutoSave(); // stub, implemented in Teil 4/4
  }

  function updateInductionStatusText() {
    const oralDone = !!currentEmployee?.inductions?.oral?.completed;
    const orgDone  = !!currentEmployee?.inductions?.org?.completed;

    $("oralStatusText").textContent = oralDone ? "BESTANDEN" : "AUSSTEHEND";
    $("orgStatusText").textContent  = orgDone ? "BESTANDEN" : "AUSSTEHEND";

    $("oralCompletedAt").textContent = formatDateTime(currentEmployee?.inductions?.oral?.completedAt);
    $("orgCompletedAt").textContent  = formatDateTime(currentEmployee?.inductions?.org?.completedAt);

    // Card accents
    $("cardOral").style.borderColor = oralDone ? "rgba(16,185,129,.35)" : "rgba(255,255,255,.12)";
    $("cardOrg").style.borderColor  = orgDone  ? "rgba(16,185,129,.35)" : "rgba(255,255,255,.12)";
  }

  /***********************
   * 9) Templates + Copy
   ***********************/
  function buildTemplate(type) {
    if (!currentEmployee) return "";
    const isOral = type === "oral";
    const done = isOral ? !!currentEmployee.inductions?.oral?.completed : !!currentEmployee.inductions?.org?.completed;
    const data = isOral ? currentEmployee.oralData : currentEmployee.orgData;

    const name = currentEmployee.name || "";
    const dn = currentEmployee.dn || "";
    const unit = currentEmployee.unit || "";
    const rank = currentEmployee.rank || "";
    const examiner = data?.examiner || "";
    const date = data?.date ? new Date(data.date).toLocaleDateString("de-DE") : "";
    const t1 = data?.timeStart || "";
    const t2 = data?.timeEnd || "";
    const person = data?.person || "";
    const notes = data?.notes || "";

    return `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/////////////////////////////////////////////////////////////////////////
${isOral ? "MÃ¼ndliche" : "Organisatorische"} Einweisung / ${done ? "bestanden" : "ausstehend"}

PrÃ¼fer : ${examiner}
Name: ${name}
DN: ${dn}
Hauptunit: ${unit}
Rang: ${rank}
Datum: ${date}
Uhrzeit: ${t1} ${isOral ? "bis" : "-"} ${t2}
Beteiligte: ${person}
Sonstiges: ${notes}

/////////////////////////////////////////////////////////////////////////
<@&1097625910242447422>
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
  }

  function updateTemplates() {
    if (!currentEmployee) return;
    $("tplOral").textContent = buildTemplate("oral");
    $("tplOrg").textContent  = buildTemplate("org");
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      // fallback
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      } catch {
        return false;
      }
    }
  }

  /***********************
   * 10) Dashboard + Insights
   ***********************/
  function updateDashboardAndInsights() {
    // KPI
    $("totalEmployees").textContent = String(employees.length);

    const pendingOral = employees.filter(e => !e.inductions?.oral?.completed).length;
    const pendingOrg  = employees.filter(e => !e.inductions?.org?.completed).length;

    $("pendingOral").textContent = String(pendingOral);
    $("pendingOrg").textContent  = String(pendingOrg);

    // Avg days to complete (startDate -> both completedAt max)
    const durations = [];
    for (const e of employees) {
      if (!e.startDate) continue;
      const oralAt = e.inductions?.oral?.completedAt;
      const orgAt  = e.inductions?.org?.completedAt;
      if (!oralAt || !orgAt) continue;
      // completion date = later of the two
      const completion = (new Date(oralAt) > new Date(orgAt)) ? oralAt : orgAt;
      const d = daysBetween(e.startDate, completion);
      if (typeof d === "number") durations.push(d);
    }
    if (durations.length === 0) {
      $("avgDaysToComplete").textContent = "â€“";
    } else {
      const avg = Math.round(durations.reduce((a,b)=>a+b,0) / durations.length);
      $("avgDaysToComplete").textContent = String(avg);
    }

    // Insights: Top PrÃ¼fer
    const counts = new Map(); // examiner -> count
    for (const e of employees) {
      const oralExam = e.inductions?.oral?.examiner || e.oralData?.examiner;
      const orgExam  = e.inductions?.org?.examiner  || e.orgData?.examiner;
      if (oralExam) counts.set(oralExam, (counts.get(oralExam) || 0) + 1);
      if (orgExam)  counts.set(orgExam, (counts.get(orgExam)  || 0) + 1);
    }
    const top = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const topBox = $("topExaminers");
    topBox.innerHTML = "";
    if (top.length === 0) {
      topBox.innerHTML = `<div style="color: var(--gray); font-weight:800;">Keine PrÃ¼ferdaten vorhanden.</div>`;
    } else {
      top.forEach(([name, cnt]) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.innerHTML = `<span>${name}</span><span style="color:white; font-weight:900;">${cnt}</span>`;
        topBox.appendChild(row);
      });
    }

    // Insights: Unit-Verteilung
    const units = new Map();
    for (const e of employees) {
      const u = e.unit || "Keine Unit";
      units.set(u, (units.get(u) || 0) + 1);
    }
    const unitArr = Array.from(units.entries()).sort((a,b)=>b[1]-a[1]);
    const total = employees.length || 1;
    const unitBox = $("unitDistribution");
    unitBox.innerHTML = "";
    unitArr.slice(0,10).forEach(([u, cnt]) => {
      const pct = Math.round((cnt / total) * 100);
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:12px; font-weight:900; color: var(--gray-light);">
          <span>${u}</span>
          <span style="color:white;">${cnt} (${pct}%)</span>
        </div>
        <div style="height:10px; background: rgba(255,255,255,.08); border-radius:999px; overflow:hidden; margin-top:6px;">
          <div style="height:10px; width:${pct}%; background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);"></div>
        </div>
      `;
      unitBox.appendChild(wrap);
    });

    // Insights: Overdue list
    const overdue = employees.filter(e => isOverdue(e, 7)).slice(0, 10);
    const overdueBox = $("overdueList");
    overdueBox.innerHTML = "";
    if (overdue.length === 0) {
      overdueBox.innerHTML = `<div style="color: var(--gray); font-weight:800;">Keine Ã¼berfÃ¤lligen FÃ¤lle (nach Beispielregel).</div>`;
    } else {
      overdue.forEach(e => {
        const oralDone = !!e.inductions?.oral?.completed;
        const orgDone  = !!e.inductions?.org?.completed;
        const line = document.createElement("div");
        line.style.display = "flex";
        line.style.justifyContent = "space-between";
        line.style.gap = "12px";
        line.innerHTML = `
          <span>${e.name} (DN ${e.dn})</span>
          <span style="color:white; font-weight:900;">${oralDone ? "Oâœ“" : "Oâœ—"} ${orgDone ? "Gâœ“" : "Gâœ—"}</span>
        `;
        overdueBox.appendChild(line);
      });
    }
  }

  /***********************
   * 11) Modals
   ***********************/
  function openModal(id) {
    const el = $(id);
    el.style.display = "flex";
    el.addEventListener("click", (ev) => {
      if (ev.target === el) closeModal(id);
    }, { once: true });
  }
  function closeModal(id) {
    $(id).style.display = "none";
  }

  /***********************
   * 12) Create/Edit/Delete (core)
   ***********************/
  function resetNewModalDefaults() {
    $("newEmployeeName").value = "";
    $("newEmployeeDN").value = "";
    $("newEmployeeUnit").value = "";
    $("newEmployeeRank").value = "";
    $("newEmployeeStartDate").value = isoToday();
    $("newEmployeeStatus").value = "active";
  }

  async function createEmployee() {
    const name = $("newEmployeeName").value.trim();
    const dn = $("newEmployeeDN").value.trim();
    const unit = $("newEmployeeUnit").value.trim();
    const rank = $("newEmployeeRank").value.trim();
    const startDate = $("newEmployeeStartDate").value || "";
    const status = $("newEmployeeStatus").value || "active";

    if (!name || !dn) {
      showNotification("Name und DN sind Pflichtfelder.", "warning");
      return;
    }

    // DN uniqueness check (simple)
    const exists = employees.some(e => String(e.dn) === String(dn));
    if (exists) {
      showNotification("DN existiert bereits. Bitte eindeutige DN verwenden.", "warning");
      return;
    }

    const id = `EMP-${Date.now()}-${Math.random().toString(36).slice(2,9)}`;

    const emp = {
      id,
      name, dn, unit, rank,
      startDate,
      status,
      supervisor: null,
      mentor: null,
      tags: [],
      notesInternal: "",

      inductions: {
        oral: { completed: false, completedAt: null, examiner: "" },
        org:  { completed: false, completedAt: null, examiner: "" }
      },
      oralData: { examiner:"", date: isoToday(), timeStart:"16:40", timeEnd:"18:00", person:"", notes:"" },
      orgData:  { examiner:"", date: isoToday(), timeStart:"22:10", timeEnd:"23:05", person:"", notes:"" }
    };

    try {
      await saveEmployeeToFirestore(emp);
      employees.unshift(emp);
      closeModal("newEmployeeModal");
      renderEmployeeList();
      updateDashboardAndInsights();
      selectEmployee(emp.id);
      showNotification(`Mitarbeiter "${name}" erstellt.`, "success");

      // Audit logging in Teil 4/4
      writeAuditLogStub("EMP_CREATED", emp.id, null, { name, dn, unit, rank });
    } catch (e) {
      console.error(e);
      showNotification("Fehler beim Erstellen.", "error");
    }
  }

  function openEditModal() {
    if (!currentEmployee) return;

    $("editEmployeeName").value = currentEmployee.name || "";
    $("editEmployeeDN").value = currentEmployee.dn || "";
    $("editEmployeeUnit").value = currentEmployee.unit || "";
    $("editEmployeeRank").value = currentEmployee.rank || "";
    $("editEmployeeStartDate").value = currentEmployee.startDate || "";
    $("editEmployeeStatus").value = currentEmployee.status || "active";

    openModal("editEmployeeModal");
  }

  async function saveEditedEmployee() {
    if (!currentEmployee) return;

    const newName = $("editEmployeeName").value.trim();
    const newDn = $("editEmployeeDN").value.trim();
    if (!newName || !newDn) {
      showNotification("Name und DN sind Pflichtfelder.", "warning");
      return;
    }

    // DN uniqueness check (exclude current)
    const exists = employees.some(e => e.id !== currentEmployee.id && String(e.dn) === String(newDn));
    if (exists) {
      showNotification("DN existiert bereits. Bitte eindeutige DN verwenden.", "warning");
      return;
    }

    const before = { ...currentEmployee };

    currentEmployee.name = newName;
    currentEmployee.dn = newDn;
    currentEmployee.unit = $("editEmployeeUnit").value.trim();
    currentEmployee.rank = $("editEmployeeRank").value.trim();
    currentEmployee.startDate = $("editEmployeeStartDate").value || "";
    currentEmployee.status = $("editEmployeeStatus").value || "active";

    try {
      await saveEmployeeToFirestore(currentEmployee);
      closeModal("editEmployeeModal");
      updateEmployeeHeader();
      renderEmployeeList();
      updateDashboardAndInsights();
      showNotification("Mitarbeiter gespeichert.", "success");

      // Audit diff in Teil 4/4
      writeAuditLogStub("EMP_UPDATED", currentEmployee.id, before, currentEmployee);
    } catch (e) {
      console.error(e);
      showNotification("Fehler beim Speichern.", "error");
    }
  }

  async function deleteCurrentEmployee() {
    if (!currentEmployee) return;
    const ok = confirm(`Mitarbeiter "${currentEmployee.name}" (DN ${currentEmployee.dn}) wirklich lÃ¶schen?`);
    if (!ok) return;

    const id = currentEmployee.id;
    try {
      await deleteEmployeeFromFirestore(id);
      employees = employees.filter(e => e.id !== id);
      currentEmployee = null;

      $("employeeHeader").style.display = "none";
      $("tabs").style.display = "none";
      $("tabDetails").style.display = "none";
      $("tabAudit").style.display = "none";
      $("tabInsights").style.display = "none";

      renderEmployeeList();
      updateDashboardAndInsights();
      closeModal("editEmployeeModal");
      showNotification("Mitarbeiter gelÃ¶scht.", "success");

      // Audit in Teil 4/4
      writeAuditLogStub("EMP_DELETED", id, null, null);
    } catch (e) {
      console.error(e);
      showNotification("Fehler beim LÃ¶schen.", "error");
    }
  }

  /***********************
   * 13) Wiring (Events)
   ***********************/
  document.addEventListener("DOMContentLoaded", async () => {
    // sidebar filter buttons
    document.querySelectorAll(".sidebar-filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".sidebar-filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter || "all";
        renderEmployeeList();
      });
    });

    // search
    $("searchEmployees").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase().trim();
      document.querySelectorAll(".employee-card").forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? "block" : "none";
      });
    });

    // tabs
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const tabId = btn.dataset.tab;
        switchTab(tabId);

        // Audit load in Teil 4/4
        if (tabId === "tabAudit") {
          await loadAuditForCurrentEmployeeStub();
        }
      });
    });

    // New employee
    $("btnNewEmployee").addEventListener("click", () => {
      resetNewModalDefaults();
      openModal("newEmployeeModal");
    });
    $("btnCloseNewModal").addEventListener("click", () => closeModal("newEmployeeModal"));
    $("btnCancelNew").addEventListener("click", () => closeModal("newEmployeeModal"));
    $("btnCreateNew").addEventListener("click", createEmployee);

    // Edit employee
    $("btnEditEmployee").addEventListener("click", openEditModal);
    $("btnCloseEditModal").addEventListener("click", () => closeModal("editEmployeeModal"));
    $("btnCancelEdit").addEventListener("click", () => closeModal("editEmployeeModal"));
    $("btnSaveEdit").addEventListener("click", saveEditedEmployee);
    $("btnDeleteEmployee").addEventListener("click", deleteCurrentEmployee);

    // Toggle inductions
    $("btnToggleOral").addEventListener("click", () => {
      readFormIntoEmployee();
      const now = !currentEmployee?.inductions?.oral?.completed;
      setInduction("oral", now);
    });
    $("btnToggleOrg").addEventListener("click", () => {
      readFormIntoEmployee();
      const now = !currentEmployee?.inductions?.org?.completed;
      setInduction("org", now);
    });

    // Complete both quickly
    $("btnCompleteBoth").addEventListener("click", () => {
      readFormIntoEmployee();
      setInduction("oral", true);
      setInduction("org", true);
    });

    // Copy buttons
    $("btnCopyOral").addEventListener("click", async () => {
      const ok = await copyToClipboard($("tplOral").textContent);
      showNotification(ok ? "MÃ¼ndliche Vorlage kopiert." : "Kopieren fehlgeschlagen.", ok ? "success" : "error");
      // Audit in Teil 4/4
      writeAuditLogStub("TEMPLATE_COPIED", currentEmployee?.id, null, { type: "oral" });
    });

    $("btnCopyOrg").addEventListener("click", async () => {
      const ok = await copyToClipboard($("tplOrg").textContent);
      showNotification(ok ? "Organisatorische Vorlage kopiert." : "Kopieren fehlgeschlagen.", ok ? "success" : "error");
      writeAuditLogStub("TEMPLATE_COPIED", currentEmployee?.id, null, { type: "org" });
    });

    $("btnCopyBoth").addEventListener("click", async () => {
      if (!currentEmployee) return;
      const combined = $("tplOral").textContent + "\n\n" + $("tplOrg").textContent;
      const ok = await copyToClipboard(combined);
      showNotification(ok ? "Beide Vorlagen kopiert." : "Kopieren fehlgeschlagen.", ok ? "success" : "error");
      writeAuditLogStub("TEMPLATE_COPIED", currentEmployee?.id, null, { type: "both" });
    });

    // Manual save button (actual implementation in Teil 4/4)
    $("btnSaveNow").addEventListener("click", async () => {
      await flushSaveNowStub();
    });

    // Form input listeners: mark dirty + autosave (debounce in Teil 4/4)
    const watchIds = [
      "startDate","statusSelect","tagsInput","supervisorInput","mentorInput","notesInternal",
      "oralExaminer","oralDate","oralTimeStart","oralTimeEnd","oralPerson","oralNotes",
      "orgExaminer","orgDate","orgTimeStart","orgTimeEnd","orgPerson","orgNotes"
    ];
    watchIds.forEach(id => {
      $(id).addEventListener("input", () => onFormChanged());
      $(id).addEventListener("change", () => onFormChanged());
    });

    // Initial load
    await loadEmployees();

    // default: hide panels until employee selected
    $("tabDetails").style.display = "none";
    $("tabAudit").style.display = "none";
    $("tabInsights").style.display = "none";
    $("tabs").style.display = "none";
  });

  function onFormChanged() {
    if (!currentEmployee) return;
    readFormIntoEmployee();
    updateEmployeeHeader();
    updateTemplates();
    setDirty(true);
    scheduleAutoSave(); // implemented in Teil 4/4
  }

  /***********************
   * 14) STUBS to be replaced in Teil 4/4
   ***********************/
  function setDirty(val) {
    isDirty = !!val;
    // Save-pill UI update comes in Teil 4/4
  }
  function scheduleAutoSave() {
    // Debounce implementation in Teil 4/4
  }
  async function flushSaveNowStub() {
    // Manual save implementation in Teil 4/4
    showNotification("Teil 4/4 fehlt noch: Save-Logik.", "warning");
  }
  async function loadAuditForCurrentEmployeeStub() {
    // Audit load in Teil 4/4
    $("auditList").innerHTML = `<div style="color: var(--gray); font-weight:800;">Teil 4/4 fehlt noch: Audit-Load.</div>`;
  }
  function writeAuditLogStub(event, employeeId, before, after) {
    // Audit write in Teil 4/4
  }
</script>

<script>
  /*********************************************************
   * 14) REPLACE STUBS (Debounce Save + Audit Write/Load)
   *********************************************************/

  // Debounce timer
  let saveTimer = null;

  // Optional: periodic autosave if dirty
  let periodicAutoSaveTimer = null;

  function setSavePill(state) {
    // state: "ok" | "dirty" | "saving"
    const pill = $("savePill");
    const text = $("savePillText");
    const btnSaveNow = $("btnSaveNow");

    pill.classList.remove("ok", "dirty", "saving");

    if (state === "ok") {
      pill.classList.add("ok");
      pill.innerHTML = `<i class="fas fa-circle-check"></i><span id="savePillText">Gespeichert</span>`;
      btnSaveNow.style.display = "none";
      return;
    }
    if (state === "dirty") {
      pill.classList.add("dirty");
      pill.innerHTML = `<i class="fas fa-pen-to-square"></i><span id="savePillText">Ungespeichert</span>`;
      btnSaveNow.style.display = "inline-flex";
      return;
    }
    if (state === "saving") {
      pill.classList.add("saving");
      pill.innerHTML = `<i class="fas fa-rotate fa-spin"></i><span id="savePillText">Speichertâ€¦</span>`;
      btnSaveNow.style.display = "none";
      return;
    }
  }

  function setDirty(val) {
    isDirty = !!val;
    if (!currentEmployee) {
      setSavePill("ok");
      return;
    }
    if (isSaving) {
      setSavePill("saving");
      return;
    }
    setSavePill(isDirty ? "dirty" : "ok");
  }

  function ensurePeriodicAutosave() {
    // optional: autosave every 10s if dirty
    if (periodicAutoSaveTimer) return;
    periodicAutoSaveTimer = setInterval(async () => {
      if (!currentEmployee) return;
      if (!isDirty) return;
      if (isSaving) return;
      await flushSaveNow("PERIODIC_AUTOSAVE");
    }, 10000);
  }

  function scheduleAutoSave() {
    if (!currentEmployee) return;

    ensurePeriodicAutosave();

    // Debounce: 800ms
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      if (!currentEmployee) return;
      if (!isDirty) return;
      await flushSaveNow("DEBOUNCED_AUTOSAVE");
    }, 800);
  }

  async function flushSaveNow(reason = "MANUAL_SAVE") {
    if (!currentEmployee) return;
    if (isSaving) return;

    // read current form state before saving
    readFormIntoEmployee();

    isSaving = true;
    setSavePill("saving");

    // Build "before" snapshot for diff
    const before = JSON.parse(JSON.stringify(currentEmployee));

    try {
      await saveEmployeeToFirestore(currentEmployee);

      // Update local object "lastUpdated" is serverTimestamp in Firestore; we keep UI stable
      isDirty = false;
      isSaving = false;
      setDirty(false);

      // Update KPIs & list
      renderEmployeeList();
      updateDashboardAndInsights();

      // Audit: FORM_SAVED only when it was dirty and triggered by any reason
      // Diff can be expensive; we compute diff against last known "before" snapshot.
      await writeAuditLog("FORM_SAVED", currentEmployee.id, computeDiff(before, currentEmployee), { reason });

      if (reason === "MANUAL_SAVE") {
        showNotification("Ã„nderungen gespeichert.", "success");
      }
    } catch (e) {
      console.error(e);
      isSaving = false;
      setDirty(true);
      showNotification("Fehler beim Speichern (Firestore).", "error");
    }
  }

  // Replace the manual save stub called by the button in Teil 3/4
  async function flushSaveNowStub() {
    await flushSaveNow("MANUAL_SAVE");
  }

  /*********************************************************
   * Audit Log: write + diff
   *********************************************************/
  function computeDiff(beforeObj, afterObj) {
    // returns flat diff: { "path.to.field": {from,to}, ... }
    // Only compares relevant fields for HR system.
    const diff = {};

    const pick = (o) => ({
      name: o?.name || "",
      dn: o?.dn || "",
      unit: o?.unit || "",
      rank: o?.rank || "",
      startDate: o?.startDate || "",
      status: o?.status || "active",
      supervisor: o?.supervisor || null,
      mentor: o?.mentor || null,
      tags: Array.isArray(o?.tags) ? o.tags : [],
      notesInternal: o?.notesInternal || "",
      inductions: o?.inductions || {},
      oralData: o?.oralData || {},
      orgData: o?.orgData || {}
    });

    const a = pick(beforeObj);
    const b = pick(afterObj);

    // Deep compare by JSON stringify for sub-objects; path-level for important fields
    const compareField = (path, av, bv) => {
      const aj = JSON.stringify(av ?? null);
      const bj = JSON.stringify(bv ?? null);
      if (aj !== bj) diff[path] = { from: av ?? null, to: bv ?? null };
    };

    compareField("name", a.name, b.name);
    compareField("dn", a.dn, b.dn);
    compareField("unit", a.unit, b.unit);
    compareField("rank", a.rank, b.rank);
    compareField("startDate", a.startDate, b.startDate);
    compareField("status", a.status, b.status);
    compareField("supervisor", a.supervisor, b.supervisor);
    compareField("mentor", a.mentor, b.mentor);
    compareField("tags", a.tags, b.tags);
    compareField("notesInternal", a.notesInternal, b.notesInternal);

    // Inductions (key fields)
    compareField("inductions.oral", a.inductions?.oral || {}, b.inductions?.oral || {});
    compareField("inductions.org", a.inductions?.org || {}, b.inductions?.org || {});

    // Form data (optional but useful)
    compareField("oralData", a.oralData, b.oralData);
    compareField("orgData", a.orgData, b.orgData);

    return diff;
  }

  function getActor() {
    // If you later use Firebase Auth, set uid/displayName here.
    return { uid: null, name: "System" };
  }

  async function writeAuditLog(event, employeeId, changes = null, meta = null) {
    if (!employeeId) return;

    const doc = {
      ts: firebase.firestore.FieldValue.serverTimestamp(),
      actor: getActor(),
      employeeId,
      event,
      changes: changes || null,
      meta: meta || null
    };

    await db.collection("hrAuditLogs").add(doc);
  }

  // Replace stub calls used earlier
  function writeAuditLogStub(event, employeeId, before, after) {
    // Keep it compatible with Teil 3/4 calls:
    // - if before/after provided, compute diff
    // - else store payload as meta
    (async () => {
      try {
        if (!employeeId) return;

        if (before && after) {
          const diff = computeDiff(before, after);
          await writeAuditLog(event, employeeId, diff, null);
          return;
        }

        // if before/after not provided, store after as meta
        await writeAuditLog(event, employeeId, null, after || null);
      } catch (e) {
        console.error("Audit write failed:", e);
      }
    })();
  }

  /*********************************************************
   * Hook improvements: Induction toggle -> immediate save + audit
   *********************************************************/
  // Override setInduction behavior with more precise audit event
  const _setInductionOriginal = setInduction;
  setInduction = function(type, completed) {
    if (!currentEmployee) return;

    // snapshot before for diff
    const before = JSON.parse(JSON.stringify(currentEmployee));

    _setInductionOriginal(type, completed);

    // write a specific audit event for toggles
    const diff = computeDiff(before, currentEmployee);

    // trigger save (debounced already scheduled), but audit now
    writeAuditLog("INDUCTION_TOGGLED", currentEmployee.id, diff, { scope: type, completed: !!completed })
      .catch(e => console.error("Audit toggle failed:", e));
  };

  /*********************************************************
   * Audit Load: last 50 by employeeId
   *********************************************************/
  async function loadAuditForCurrentEmployeeStub() {
    await loadAuditForCurrentEmployee();
  }

  async function loadAuditForCurrentEmployee() {
    const list = $("auditList");
    if (!currentEmployee) {
      list.innerHTML = `<div style="color: var(--gray); font-weight:800;">Kein Mitarbeiter ausgewÃ¤hlt.</div>`;
      return;
    }

    list.innerHTML = `<div style="color: var(--gray); font-weight:800;">Lade Auditâ€¦</div>`;

    try {
      const snap = await db.collection("hrAuditLogs")
        .where("employeeId", "==", currentEmployee.id)
        .orderBy("ts", "desc")
        .limit(50)
        .get();

      const rows = [];
      snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));

      if (rows.length === 0) {
        list.innerHTML = `<div style="color: var(--gray); font-weight:800;">Keine Audit-EintrÃ¤ge vorhanden.</div>`;
        return;
      }

      list.innerHTML = "";
      rows.forEach(r => {
        const item = document.createElement("div");
        item.className = "audit-item";

        const when = r.ts ? formatDateTime(r.ts) : "â€“";
        const actor = r.actor?.name || "System";
        const event = r.event || "EVENT";
        const meta = r.meta ? JSON.stringify(r.meta) : "";

        let changesText = "";
        if (r.changes && typeof r.changes === "object") {
          // pretty print but keep small
          const keys = Object.keys(r.changes);
          const limited = keys.slice(0, 30).reduce((acc, k) => (acc[k] = r.changes[k], acc), {});
          changesText = JSON.stringify(limited, null, 2);
          if (keys.length > 30) changesText += `\n... (+${keys.length - 30} weitere Felder)`;
        } else if (meta) {
          changesText = meta;
        } else {
          changesText = "â€”";
        }

        item.innerHTML = `
          <div class="audit-top">
            <div class="audit-event">${event}</div>
            <div class="audit-meta">${when} â€¢ ${actor}</div>
          </div>
          <div class="audit-changes">${changesText}</div>
        `;
        list.appendChild(item);
      });

    } catch (e) {
      console.error(e);
      list.innerHTML = `<div style="color: var(--danger); font-weight:900;">Fehler beim Laden des Audit Logs.</div>`;
    }
  }

  // Reload button
  document.addEventListener("DOMContentLoaded", () => {
    $("btnReloadAudit")?.addEventListener("click", loadAuditForCurrentEmployee);
  });

  /*********************************************************
   * Improve Create/Edit/Delete audit calls (more precise)
   *********************************************************/
  // Wrap createEmployee / saveEditedEmployee / deleteCurrentEmployee with direct audit events.
  const _createEmployeeOriginal = createEmployee;
  createEmployee = async function() {
    // create writes audit stub already, but we want consistent event naming.
    await _createEmployeeOriginal();
    // Audit for create is already written in Teil 3/4; keep as is.
  };

  const _saveEditedEmployeeOriginal = saveEditedEmployee;
  saveEditedEmployee = async function() {
    if (!currentEmployee) return;
    const before = JSON.parse(JSON.stringify(currentEmployee));
    await _saveEditedEmployeeOriginal();
    // currentEmployee already updated; event already stubbed in Teil 3/4. Keep.
    // If you want stronger guarantee, you can explicitly write here after save:
    // await writeAuditLog("EMP_UPDATED", currentEmployee.id, computeDiff(before, currentEmployee), null);
  };

  const _deleteCurrentEmployeeOriginal = deleteCurrentEmployee;
  deleteCurrentEmployee = async function() {
    const id = currentEmployee?.id;
    await _deleteCurrentEmployeeOriginal();
    // deletion audit stub already executed in Teil 3/4.
  };

  /*********************************************************
   * Initial pill state
   *********************************************************/
  document.addEventListener("DOMContentLoaded", () => {
    setSavePill("ok");
  });
</script>    
