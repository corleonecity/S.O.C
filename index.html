          const height = parseFloat(document.getElementById('vitalHeight').value) / 100; // Convert to meters
            const weight = parseFloat(document.getElementById('vitalWeight').value);
            const bmiStatus = document.getElementById('bmiStatus');
            
            if (height && weight && height > 0) {
                const bmi = weight / (height * height);
                document.getElementById('vitalBMI').value = bmi.toFixed(1);
                
                if (bmi < 18.5) {
                    bmiStatus.textContent = 'Untergewicht';
                    bmiStatus.className = 'vital-status status-warning';
                } else if (bmi >= 18.5 && bmi <= 24.9) {
                    bmiStatus.textContent = 'Normal';
                    bmiStatus.className = 'vital-status status-normal';
                } else if (bmi >= 25 && bmi <= 29.9) {
                    bmiStatus.textContent = '√úbergewicht';
                    bmiStatus.className = 'vital-status status-warning';
                } else {
                    bmiStatus.textContent = 'Adipositas';
                    bmiStatus.className = 'vital-status status-danger';
                }
            } else {
                document.getElementById('vitalBMI').value = '';
                bmiStatus.textContent = 'Berechnen';
                bmiStatus.className = 'vital-status';
            }
        }

        function generateVitalAnalysis() {
            const analysisDiv = document.getElementById('vitalAnalysis');
            
            // Get current values
            const pulse = document.getElementById('vitalPulse').value;
            const bpHigh = document.getElementById('vitalBpHigh').value;
            const bpLow = document.getElementById('vitalBpLow').value;
            const temp = document.getElementById('vitalTemp').value;
            const resp = document.getElementById('vitalRespiration').value;
            const oxygen = document.getElementById('vitalOxygen').value;
            const height = document.getElementById('vitalHeight').value;
            const weight = document.getElementById('vitalWeight').value;
            const bmi = document.getElementById('vitalBMI').value;
            const fitness = document.getElementById('vitalFitness').value;
            const lastMeal = document.getElementById('vitalLastMeal').value;
            const mobility = document.getElementById('vitalMobility').value;
            
            let analysisHTML = `
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Wert</th>
                            <th>Normalwert</th>
                            <th>Bewertung</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Helper function to get status
            function getStatus(value, min, max) {
                if (!value) return {text: 'Nicht gemessen', class: ''};
                const numValue = parseFloat(value);
                if (numValue >= min && numValue <= max) {
                    return {text: 'Normal', class: 'status-normal'};
                } else if (numValue < min) {
                    return {text: 'Unter Norm', class: 'status-warning'};
                } else {
                    return {text: '√úber Norm', class: 'status-danger'};
                }
            }
            
            // Add rows for each parameter
            const params = [
                {name: 'Puls', value: pulse, unit: 'bpm', min: 60, max: 100},
                {name: 'Blutdruck', value: bpHigh && bpLow ? `${bpHigh}/${bpLow}` : '', unit: 'mmHg', min: '110/60', max: '140/90'},
                {name: 'K√∂rpertemperatur', value: temp, unit: '¬∞C', min: 36.1, max: 37.5},
                {name: 'Atemfrequenz', value: resp, unit: '/min', min: 12, max: 20},
                {name: 'Sauerstoffs√§ttigung', value: oxygen, unit: '%', min: 95, max: 100}
            ];
            
            params.forEach(param => {
                let status;
                if (param.name === 'Blutdruck') {
                    if (bpHigh && bpLow) {
                        const high = parseFloat(bpHigh);
                        const low = parseFloat(bpLow);
                        if (high >= 110 && high <= 140 && low >= 60 && low <= 90) {
                            status = {text: 'Normal', class: 'status-normal'};
                        } else if (high < 110 || low < 60) {
                            status = {text: 'Niedrig', class: 'status-warning'};
                        } else {
                            status = {text: 'Hoch', class: 'status-danger'};
                        }
                    } else {
                        status = {text: 'Nicht gemessen', class: ''};
                    }
                } else {
                    status = getStatus(param.value, param.min, param.max);
                }
                
                analysisHTML += `
                    <tr>
                        <td>${param.name}</td>
                        <td>${param.value || '-'} ${param.value ? param.unit : ''}</td>
                        <td>${param.min} - ${param.max} ${param.unit || ''}</td>
                        <td><span class="patient-status ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            });
            
            // Add BMI row
            if (bmi) {
                let bmiStatus;
                const bmiNum = parseFloat(bmi);
                if (bmiNum < 18.5) bmiStatus = {text: 'Untergewicht', class: 'status-warning'};
                else if (bmiNum >= 18.5 && bmiNum <= 24.9) bmiStatus = {text: 'Normal', class: 'status-normal'};
                else if (bmiNum >= 25 && bmiNum <= 29.9) bmiStatus = {text: '√úbergewicht', class: 'status-warning'};
                else bmiStatus = {text: 'Adipositas', class: 'status-danger'};
                
                analysisHTML += `
                    <tr>
                        <td>BMI</td>
                        <td>${bmi}</td>
                        <td>18.5 - 24.9</td>
                        <td><span class="patient-status ${bmiStatus.class}">${bmiStatus.text}</span></td>
                    </tr>
                `;
            }
            
            // Add fitness row
            if (fitness) {
                const fitnessText = {
                    athletic: 'Sportlich',
                    average: 'Durchschnittlich',
                    weak: 'Schwach'
                }[fitness] || fitness;
                
                analysisHTML += `
                    <tr>
                        <td>Fitness-Eindruck</td>
                        <td>${fitnessText}</td>
                        <td>-</td>
                        <td><span class="patient-status status-info">Subjektiv</span></td>
                    </tr>
                `;
            }
            
            // Add last meal row
            if (lastMeal) {
                let mealStatus;
                const hours = parseFloat(lastMeal);
                if (hours <= 6) mealStatus = {text: 'Normal', class: 'status-normal'};
                else if (hours <= 12) mealStatus = {text: 'Lange Pause', class: 'status-warning'};
                else mealStatus = {text: 'Fastend', class: 'status-danger'};
                
                analysisHTML += `
                    <tr>
                        <td>Letzte Mahlzeit</td>
                        <td>${lastMeal} Stunden</td>
                        <td>0 - 6 Stunden</td>
                        <td><span class="patient-status ${mealStatus.class}">${mealStatus.text}</span></td>
                    </tr>
                `;
            }
            
            // Add mobility row
            if (mobility) {
                const mobilityText = {
                    normal: 'Normal',
                    limited: 'Eingeschr√§nkt'
                }[mobility] || mobility;
                
                const mobilityStatus = mobility === 'normal' ? 
                    {text: 'Normal', class: 'status-normal'} : 
                    {text: 'Eingeschr√§nkt', class: 'status-warning'};
                
                analysisHTML += `
                    <tr>
                        <td>Mobilit√§t</td>
                        <td>${mobilityText}</td>
                        <td>Normal</td>
                        <td><span class="patient-status ${mobilityStatus.class}">${mobilityStatus.text}</span></td>
                    </tr>
                `;
            }
            
            analysisHTML += `
                    </tbody>
                </table>
            `;
            
            // Add summary
            analysisHTML += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <h4 style="color: var(--army-tan); margin-bottom: 10px;">Zusammenfassung:</h4>
            `;
            
            // Count abnormal values
            const abnormalCount = document.querySelectorAll('.vital-status.status-warning, .vital-status.status-danger').length;
            
            if (abnormalCount === 0) {
                analysisHTML += `<p>‚úÖ Alle Vitalparameter im Normalbereich. Keine medizinischen Bedenken.</p>`;
            } else if (abnormalCount <= 2) {
                analysisHTML += `<p>‚ö†Ô∏è ${abnormalCount} Parameter au√üerhalb des Normbereichs. Weitere Beobachtung empfohlen.</p>`;
            } else {
                analysisHTML += `<p>üö® ${abnormalCount} Parameter au√üerhalb des Normbereichs. Dringende medizinische Untersuchung empfohlen.</p>`;
            }
            
            analysisHTML += `</div>`;
            
            analysisDiv.innerHTML = analysisHTML;
        }

        // Comments System
        function openComments(questionId) {
            currentQuestion = questionId;
            
            // Set modal title
            const questionText = document.querySelector(`[data-question="${questionId}"]`)?.closest('.question-item')?.querySelector('.question-text')?.textContent;
            document.getElementById('commentQuestionTitle').textContent = questionText || `Frage ${questionId}`;
            
            // Load comments
            loadComments();
            
            // Show modal
            document.getElementById('commentModal').classList.add('active');
        }

        function closeComments() {
            document.getElementById('commentModal').classList.remove('active');
            currentQuestion = null;
            document.getElementById('newComment').value = '';
        }

        function loadComments() {
            if (!currentPatient || !currentQuestion) return;
            
            const commentList = document.getElementById('commentList');
            
            // Get comments for this question
            const questionComments = comments[currentQuestion] || [];
            
            if (questionComments.length === 0) {
                commentList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Keine Kommentare</div>';
                return;
            }
            
            commentList.innerHTML = '';
            questionComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <div class="comment-author">
                        <span>${comment.author}</span>
                        <span style="font-size: 12px; color: #999;">${new Date(comment.timestamp).toLocaleString('de-DE')}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                `;
                commentList.appendChild(commentDiv);
            });
            
            // Update badge
            updateCommentBadge(currentQuestion, questionComments.length);
        }

        function addComment() {
            if (!currentPatient || !currentQuestion) return;
            
            const commentText = document.getElementById('newComment').value.trim();
            if (!commentText) return;
            
            // Initialize comments array if needed
            if (!comments[currentQuestion]) {
                comments[currentQuestion] = [];
            }
            
            // Add new comment
            const newComment = {
                text: commentText,
                author: currentUser.displayName,
                timestamp: new Date().toISOString()
            };
            
            comments[currentQuestion].push(newComment);
            
            // Clear input
            document.getElementById('newComment').value = '';
            
            // Reload comments
            loadComments();
            
            // Auto-save patient
            if (currentPatient) {
                currentPatient.comments = comments;
                autoSave();
            }
        }

        function updateCommentBadges() {
            Object.keys(comments).forEach(questionId => {
                const questionComments = comments[questionId] || [];
                updateCommentBadge(questionId, questionComments.length);
            });
        }

        function updateCommentBadge(questionId, count) {
            const badge = document.querySelector(`[data-question="${questionId}"]`)?.closest('.question-item')?.querySelector('.comment-badge');
            if (badge) {
                badge.textContent = count;
                badge.classList.toggle('has-comment', count > 0);
            }
        }

        function switchTab(tabNumber) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab${tabNumber}`).style.display = 'block';
            
            // Add active class to selected tab
            document.querySelectorAll('.tab')[tabNumber - 1].classList.add('active');
            
            // If switching to tab 3, generate analysis
            if (tabNumber === 3) {
                generateVitalAnalysis();
            }
        }

        function printReport() {
            if (!currentPatient) {
                alert('Bitte zuerst einen Patienten ausw√§hlen');
                return;
            }
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medizinisches Gutachten - ${currentPatient.firstName} ${currentPatient.lastName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .section { margin-bottom: 30px; page-break-inside: avoid; }
                        .section-title { background: #f0f0f0; padding: 10px; font-weight: bold; border-left: 4px solid #4d774e; }
                        .question { margin: 15px 0; }
                        .question-text { font-weight: bold; color: #333; }
                        .answer { margin-left: 20px; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .signature { margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>U.S. ARMY - Medizinisches Gutachten</h1>
                        <h2>${currentPatient.firstName} ${currentPatient.lastName} - ${currentPatient.rank || 'Soldat'}</h2>
                        <p><strong>Einheit:</strong> ${currentPatient.unit}</p>
                        <p><strong>Untersuchungsdatum:</strong> ${new Date(currentPatient.createdAt).toLocaleDateString('de-DE')}</p>
                        <p><strong>Gutachter:</strong> ${currentUser.displayName}</p>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Zusammenfassung & Empfehlung</h3>
                        <p><strong>Gesamteindruck:</strong><br>${document.getElementById('summaryAssessment').value || 'Nicht bewertet'}</p>
                        <p><strong>Psychologische Einsch√§tzung:</strong><br>${document.getElementById('summaryPsychological').value || 'Nicht bewertet'}</p>
                        <p><strong>Medizinische Einsch√§tzung:</strong><br>${document.getElementById('summaryMedical').value || 'Nicht bewertet'}</p>
                        <p><strong>Empfehlung:</strong> ${document.getElementById('finalRecommendation').selectedOptions[0]?.text || 'Nicht ausgew√§hlt'}</p>
                        <p><strong>Begr√ºndung:</strong><br>${document.getElementById('summaryReason').value || ''}</p>
                        <p><strong>Empfohlene Ma√ünahmen:</strong><br>${document.getElementById('summaryMeasures').value || ''}</p>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Vitalparameter</h3>
                        <table>
                            <tr><th>Parameter</th><th>Wert</th><th>Normalwert</th></tr>
                            <tr><td>Puls</td><td>${document.getElementById('vitalPulse').value || '-'} bpm</td><td>60-100 bpm</td></tr>
                            <tr><td>Blutdruck</td><td>${document.getElementById('vitalBpHigh').value || '-'}/${document.getElementById('vitalBpLow').value || '-'} mmHg</td><td>110-140/60-90 mmHg</td></tr>
                            <tr><td>K√∂rpertemperatur</td><td>${document.getElementById('vitalTemp').value || '-'} ¬∞C</td><td>36.1-37.5 ¬∞C</td></tr>
                            <tr><td>Atemfrequenz</td><td>${document.getElementById('vitalRespiration').value || '-'} /min</td><td>12-20 /min</td></tr>
                            <tr><td>Sauerstoffs√§ttigung</td><td>${document.getElementById('vitalOxygen').value || '-'} %</td><td>95-100%</td></tr>
                            <tr><td>BMI</td><td>${document.getElementById('vitalBMI').value || '-'}</td><td>18.5-24.9</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Psychologische Bewertung</h3>
                        ${getPsychologicalSummary()}
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Medizinische Bewertung</h3>
                        ${getMedicalSummary()}
                    </div>
                    
                    <div class="signature">
                        <p>Unterschrift Gutachter: _________________________</p>
                        <p>Datum: ${new Date().toLocaleDateString('de-DE')}</p>
                    </div>
                    
                    <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; right: 20px; padding: 10px; background: #4d774e; color: white; border: none; cursor: pointer;">
                        Bericht drucken
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function getPsychologicalSummary() {
            let summary = '';
            const sections = ['1.1', '1.2', '1.3', '2.1', '2.2', '2.3', '2.4', '3.1', '3.2', '3.3', '3.4', '3.5', '4.1', '4.2', '4.3', '4.4', '5.1', '5.2', '5.3', '5.4', '6.1', '6.2', '6.3', '6.4', '6.5'];
            
            sections.forEach(qId => {
                const input = document.querySelector(`[data-question="${qId}"]`);
                if (input && input.value) {
                    const questionText = input.closest('.question-item')?.querySelector('.question-text')?.textContent;
                    if (questionText) {
                        summary += `<p><strong>${questionText}</strong><br>${input.value}</p>`;
                    }
                }
            });
            
            return summary || '<p>Keine psychologischen Daten erfasst.</p>';
        }

        function getMedicalSummary() {
            let summary = '';
            const sections = ['med1', 'med2', 'med3', 'med4', 'med5', 'med6', 'med7', 'med8', 'medAllergies', 'medInjuries', 'medOther'];
            
            sections.forEach(qId => {
                const input = document.querySelector(`[data-question="${qId}"]`);
                if (input && input.value) {
                    const questionText = input.closest('.question-item')?.querySelector('.question-text')?.textContent;
                    if (questionText) {
                        summary += `<p><strong>${questionText}</strong><br>${input.value}</p>`;
                    }
                }
            });
            
            return summary || '<p>Keine medizinischen Daten erfasst.</p>';
        }

        function deletePatient() {
            if (!currentPatient) return;
            
            if (confirm(`Sind Sie sicher, dass Sie die Untersuchung von ${currentPatient.firstName} ${currentPatient.lastName} l√∂schen m√∂chten?`)) {
                // Remove from array
                const index = patients.findIndex(p => p.id === currentPatient.id);
                if (index !== -1) {
                    patients.splice(index, 1);
                }
                
                // Reset view
                currentPatient = null;
                document.getElementById('noPatientSelected').style.display = 'block';
                document.getElementById('patientContent').style.display = 'none';
                
                // Refresh list
                renderPatientList();
                
                alert('Untersuchung gel√∂scht');
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'In Bearbeitung',
                'completed': 'Abgeschlossen',
                'critical': 'Kritisch'
            };
            return statusMap[status] || status;
        }
    </script>
</body>
</html>
