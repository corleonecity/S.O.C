<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medizinisches Gutachtensystem - U.S. Army</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --army-green: #4d774e;
            --army-dark: #1a472a;
            --army-tan: #c19a6b;
            --army-light: #e8f5e8;
            --danger: #d32f2f;
            --warning: #f57c00;
            --success: #388e3c;
            --info: #1976d2;
            --dark: #121212;
            --gray: #333;
            --light-gray: #f5f5f5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--dark);
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--army-dark), var(--army-green));
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            grid-column: 1 / -1;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(45deg, white, var(--army-tan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--army-tan);
        }
        
        /* Sidebar - Aktenarchiv */
        .sidebar {
            background: var(--gray);
            border-radius: 10px;
            padding: 20px;
            height: calc(100vh - 160px);
            position: sticky;
            top: 20px;
            overflow-y: auto;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--army-green);
            border-radius: 5px;
            background: var(--dark);
            color: white;
            font-size: 14px;
        }
        
        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .patient-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--army-green);
        }
        
        .patient-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .patient-card.active {
            background: rgba(77, 119, 78, 0.3);
            border-left-color: var(--army-tan);
        }
        
        .patient-id {
            font-size: 12px;
            color: var(--army-tan);
            margin-bottom: 5px;
        }
        
        .patient-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .patient-status {
            font-size: 12px;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray);
        }
        
        .status-completed { background: var(--success); }
        .status-pending { background: var(--warning); }
        .status-critical { background: var(--danger); }
        
        .new-patient-btn {
            width: 100%;
            padding: 12px;
            background: var(--army-green);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .new-patient-btn:hover {
            background: var(--army-dark);
            transform: translateY(-2px);
        }
        
        /* Main Content */
        .main-content {
            background: var(--gray);
            border-radius: 10px;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 160px);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--army-green);
        }
        
        .patient-header-info h2 {
            font-size: 28px;
            margin-bottom: 5px;
            color: var(--army-tan);
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--army-green);
            color: white;
        }
        
        .btn-secondary {
            background: var(--dark);
            color: white;
            border: 1px solid var(--army-green);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--dark);
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 10px 20px;
            background: var(--dark);
            color: var(--army-tan);
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: var(--army-green);
            color: white;
        }
        
        /* Sections */
        .section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid var(--army-green);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            color: var(--army-tan);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 18px;
        }
        
        /* Vital Parameters */
        .vital-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .vital-item {
            background: var(--dark);
            padding: 15px;
            border-radius: 8px;
        }
        
        .vital-label {
            font-size: 14px;
            color: var(--army-tan);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vital-input {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--army-green);
            border-radius: 4px;
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        .vital-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--gray);
        }
        
        .status-normal { background: var(--success); }
        .status-warning { background: var(--warning); }
        .status-danger { background: var(--danger); }
        
        /* Questions */
        .question-group {
            margin-bottom: 25px;
        }
        
        .question-item {
            background: var(--dark);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--army-tan);
            padding-right: 40px;
        }
        
        .answer-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--army-green);
            border-radius: 5px;
            color: white;
            font-size: 14px;
            min-height: 60px;
            resize: vertical;
        }
        
        .answer-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--army-green);
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
        
        .comment-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--info);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .comment-badge.has-comment {
            background: var(--warning);
        }
        
        /* Comments Modal */
        .comment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .comment-modal.active {
            display: flex;
        }
        
        .comment-content {
            background: var(--gray);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .comment-header {
            padding: 20px;
            background: var(--army-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        .comment-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comment-item {
            background: var(--dark);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--army-green);
        }
        
        .comment-author {
            font-weight: 500;
            color: var(--army-tan);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .comment-text {
            font-size: 14px;
            color: #ddd;
        }
        
        .comment-input-area {
            display: flex;
            gap: 10px;
        }
        
        .comment-input {
            flex: 1;
            padding: 12px;
            background: var(--dark);
            border: 1px solid var(--army-green);
            border-radius: 5px;
            color: white;
            resize: vertical;
            min-height: 60px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--army-tan);
        }
        
        /* Analysis Table */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .analysis-table th, .analysis-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--army-green);
        }
        
        .analysis-table th {
            background: var(--army-dark);
            color: var(--army-tan);
        }
        
        .analysis-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                height: auto;
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .vital-grid {
                grid-template-columns: 1fr;
            }
            
            .content-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Main App - Direkter Zugang -->
    <div id="appContainer">
        <div class="header">
            <div class="logo">
                <i class="fas fa-shield-alt fa-2x"></i>
                <div>
                    <h1>U.S. ARMY - Medizinisches Gutachtensystem</h1>
                    <p style="font-size: 14px; color: #ccc;">Spezialoperationen - Vertraulich</p>
                </div>
            </div>
            <div class="user-info">
                <span id="currentUser">Aktueller Gutachter: Dr. Miller</span>
                <button onclick="changeExaminer()" class="btn btn-secondary">
                    <i class="fas fa-user-edit"></i> Gutachter ändern
                </button>
            </div>
        </div>
        
        <div class="container">
            <!-- Sidebar - Aktenarchiv -->
            <div class="sidebar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Patient suchen..." oninput="renderPatientList()">
                </div>
                
                <div class="patient-list" id="patientList">
                    <!-- Patients will be loaded here -->
                </div>
                
                <button onclick="createNewPatient()" class="new-patient-btn">
                    <i class="fas fa-plus"></i> Neue Untersuchung
                </button>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div id="noPatientSelected" style="text-align: center; padding: 50px;">
                    <i class="fas fa-user-md fa-4x" style="color: var(--army-green); margin-bottom: 20px;"></i>
                    <h3>Patient auswählen oder neue Untersuchung beginnen</h3>
                    <p>Wählen Sie einen Patienten aus der Liste oder erstellen Sie eine neue Untersuchung</p>
                </div>
                
                <div id="patientContent" style="display: none;">
                    <div class="content-header">
                        <div class="patient-header-info">
                            <h2 id="patientFullName"></h2>
                            <div style="display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                                <span><strong>ID:</strong> <span id="patientId"></span></span>
                                <span><strong>Einheit:</strong> <span id="patientUnit"></span></span>
                                <span><strong>Datum:</strong> <span id="examinationDate"></span></span>
                                <span><strong>Status:</strong> <span id="patientStatus"></span></span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button onclick="savePatient()" class="btn btn-primary">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                            <button onclick="printReport()" class="btn btn-secondary">
                                <i class="fas fa-print"></i> Drucken
                            </button>
                            <button onclick="deletePatient()" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Löschen
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab(1)">Psychologische Fragen</button>
                        <button class="tab" onclick="switchTab(2)">Medizinische Daten</button>
                        <button class="tab" onclick="switchTab(3)">Vitalparameter</button>
                        <button class="tab" onclick="switchTab(4)">Zusammenfassung</button>
                    </div>
                    
                    <!-- Tab 1: Psychological Questions -->
                    <div id="tab1" class="tab-content">
                        <!-- Section 1: Persönlichkeit & Hintergrund -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-user"></i> Abschnitt 1 – Persönlichkeit & Hintergrund
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Wie würden Sie Ihre wichtigsten Charaktereigenschaften beschreiben?</div>
                                    <textarea class="answer-input" data-question="1.1"></textarea>
                                    <div class="comment-badge" onclick="openComments('1.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Gab es in Ihrem Leben Ereignisse, die Sie nachhaltig geprägt haben?</div>
                                    <textarea class="answer-input" data-question="1.2"></textarea>
                                    <div class="comment-badge" onclick="openComments('1.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Welche Ziele verfolgen Sie langfristig in Ihrem Leben?</div>
                                    <textarea class="answer-input" data-question="1.3"></textarea>
                                    <div class="comment-badge" onclick="openComments('1.3')">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 2: Emotionale Stabilität -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-brain"></i> Abschnitt 2 – Emotionale Stabilität
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Wie reagieren Sie, wenn Sie plötzlich unter starken Druck geraten?</div>
                                    <textarea class="answer-input" data-question="2.1"></textarea>
                                    <div class="comment-badge" onclick="openComments('2.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Haben Sie Schwierigkeiten, wieder zur Ruhe zu kommen, wenn Sie gestresst sind?</div>
                                    <textarea class="answer-input" data-question="2.2"></textarea>
                                    <div class="comment-badge" onclick="openComments('2.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Haben Sie Albträume oder Schlafstörungen?</div>
                                    <select class="answer-select" data-question="2.3">
                                        <option value="">-- Auswählen --</option>
                                        <option value="never">Nie</option>
                                        <option value="rarely">Selten</option>
                                        <option value="sometimes">Manchmal</option>
                                        <option value="often">Oft</option>
                                        <option value="always">Immer</option>
                                    </select>
                                    <div class="comment-badge" onclick="openComments('2.3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Können Sie starke negative Gefühle bewusst kontrollieren?</div>
                                    <textarea class="answer-input" data-question="2.4"></textarea>
                                    <div class="comment-badge" onclick="openComments('2.4')">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 3: Aggressionskontrolle -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-angry"></i> Abschnitt 3 – Aggressionskontrolle
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Wie gehen Sie mit Situationen um, in denen Sie wütend werden?</div>
                                    <textarea class="answer-input" data-question="3.1"></textarea>
                                    <div class="comment-badge" onclick="openComments('3.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Haben Sie schon einmal die Kontrolle über Ihr Verhalten verloren?</div>
                                    <textarea class="answer-input" data-question="3.2"></textarea>
                                    <div class="comment-badge" onclick="openComments('3.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Können Sie in Konflikten ruhig bleiben, selbst wenn Sie provoziert werden?</div>
                                    <select class="answer-select" data-question="3.3">
                                        <option value="">-- Auswählen --</option>
                                        <option value="yes">Ja, immer</option>
                                        <option value="mostly">Meistens</option>
                                        <option value="sometimes">Manchmal</option>
                                        <option value="rarely">Selten</option>
                                        <option value="no">Nein</option>
                                    </select>
                                    <div class="comment-badge" onclick="openComments('3.3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Was war die schwierigste Situation, in der Sie Ihre Aggressionen beherrschen mussten?</div>
                                    <textarea class="answer-input" data-question="3.4"></textarea>
                                    <div class="comment-badge" onclick="openComments('3.4')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">5. Wie reagieren Sie auf Respektlosigkeit oder Beleidigungen?</div>
                                    <textarea class="answer-input" data-question="3.5"></textarea>
                                    <div class="comment-badge" onclick="openComments('3.5')">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 4: Teamfähigkeit & Disziplin -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-users"></i> Abschnitt 4 – Teamfähigkeit & Disziplin
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Welche Rolle übernehmen Sie üblicherweise in einem Team?</div>
                                    <textarea class="answer-input" data-question="4.1"></textarea>
                                    <div class="comment-badge" onclick="openComments('4.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Können Sie Entscheidungen akzeptieren, auch wenn Sie anderer Meinung sind?</div>
                                    <select class="answer-select" data-question="4.2">
                                        <option value="">-- Auswählen --</option>
                                        <option value="always">Immer</option>
                                        <option value="mostly">Meistens</option>
                                        <option value="depends">Kommt auf die Situation an</option>
                                        <option value="rarely">Selten</option>
                                    </select>
                                    <div class="comment-badge" onclick="openComments('4.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Haben Sie Probleme mit Autoritätspersonen?</div>
                                    <textarea class="answer-input" data-question="4.3"></textarea>
                                    <div class="comment-badge" onclick="openComments('4.3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Wie würden Sie Ihr Verantwortungsbewusstsein beschreiben?</div>
                                    <textarea class="answer-input" data-question="4.4"></textarea>
                                    <div class="comment-badge" onclick="openComments('4.4')">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 5: Moral & Entscheidungsfindung -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-balance-scale"></i> Abschnitt 5 – Moral & Entscheidungsfindung
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Wo ziehen Sie Ihre persönlichen moralischen Grenzen im Einsatz?</div>
                                    <textarea class="answer-input" data-question="5.1"></textarea>
                                    <div class="comment-badge" onclick="openComments('5.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Können Sie harte Entscheidungen treffen, wenn die Situation es erfordert?</div>
                                    <textarea class="answer-input" data-question="5.2"></textarea>
                                    <div class="comment-badge" onclick="openComments('5.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Wie gehen Sie mit Schuldgefühlen nach schwierigen Entscheidungen um?</div>
                                    <textarea class="answer-input" data-question="5.3"></textarea>
                                    <div class="comment-badge" onclick="openComments('5.3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Was ist für Sie wichtiger: der Auftrag oder das Gewissen?</div>
                                    <textarea class="answer-input" data-question="5.4"></textarea>
                                    <div class="comment-badge" onclick="openComments('5.4')">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 6: Psychische Gesundheit -->
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-heart"></i> Abschnitt 6 – Psychische Gesundheit
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Haben Sie jemals psychologische Hilfe in Anspruch genommen?</div>
                                    <select class="answer-select" data-question="6.1">
                                        <option value="">-- Auswählen --</option>
                                        <option value="no">Nein, nie</option>
                                        <option value="once">Einmal</option>
                                        <option value="multiple">Mehrmals</option>
                                        <option value="regular">Regelmäßig</option>
                                    </select>
                                    <div class="comment-badge" onclick="openComments('6.1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Haben Sie in letzter Zeit Veränderungen in Ihrer Stimmung oder Ihrem Denken bemerkt?</div>
                                    <textarea class="answer-input" data-question="6.2"></textarea>
                                    <div class="comment-badge" onclick="openComments('6.2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Leiden Sie unter Angst, Panik oder depressiven Phasen?</div>
                                    <textarea class="answer-input" data-question="6.3"></textarea>
                                    <div class="comment-badge" onclick="openComments('6.3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Konsumieren Sie Substanzen zur Stressbewältigung?</div>
                                    <textarea class="answer-input" data-question="6.4"></textarea>
                                    <div class="comment-badge" onclick="openComments('6.4')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">5. Haben / hatten Sie negative Gedanken anderen oder Ihnen selbst gegenüber?</div>
                                    <textarea class="answer-input" data-question="6.5"></textarea>
                                    <div class="comment-badge" onclick="openComments('6.5')">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Medical Data -->
                    <div id="tab2" class="tab-content" style="display: none;">
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-file-medical"></i> Abschnitt 3 – Medizinisches Gutachten
                                </h3>
                            </div>
                            
                            <!-- Vital Parameters Table -->
                            <div class="vital-grid">
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Puls (bpm)
                                        <span class="vital-status status-normal" id="pulseStatus">Normal</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalPulse" min="40" max="200" step="1" oninput="updateVitalStatus('pulse')">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Blutdruck (mmHg)
                                        <span class="vital-status status-normal" id="bpStatus">Normal</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="number" class="vital-input" id="vitalBpHigh" placeholder="systolisch" style="flex: 1;" oninput="updateVitalStatus('bp')">
                                        <span style="color: var(--army-tan);">/</span>
                                        <input type="number" class="vital-input" id="vitalBpLow" placeholder="diastolisch" style="flex: 1;" oninput="updateVitalStatus('bp')">
                                    </div>
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Körpertemperatur (°C)
                                        <span class="vital-status status-normal" id="tempStatus">Normal</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalTemp" min="35" max="42" step="0.1" oninput="updateVitalStatus('temp')">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Atemfrequenz (Atemzüge/min)
                                        <span class="vital-status status-normal" id="respStatus">Normal</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalRespiration" min="8" max="40" step="1" oninput="updateVitalStatus('resp')">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Sauerstoffsättigung (SpO2 %)
                                        <span class="vital-status status-normal" id="oxygenStatus">Normal</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalOxygen" min="80" max="100" step="1" oninput="updateVitalStatus('oxygen')">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Körpergröße (cm)
                                        <span class="vital-status">Info</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalHeight" min="140" max="220" step="1" oninput="calculateBMI()">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Gewicht (kg)
                                        <span class="vital-status">Info</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalWeight" min="40" max="150" step="0.1" oninput="calculateBMI()">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        BMI
                                        <span class="vital-status" id="bmiStatus">Berechnen</span>
                                    </div>
                                    <input type="text" class="vital-input" id="vitalBMI" readonly style="background: rgba(0,0,0,0.3);">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Fitness-Eindruck
                                        <span class="vital-status">Info</span>
                                    </div>
                                    <select class="vital-input" id="vitalFitness" style="text-align: left;">
                                        <option value="">-- Auswählen --</option>
                                        <option value="athletic">Sportlich</option>
                                        <option value="average">Durchschnittlich</option>
                                        <option value="weak">Schwach</option>
                                    </select>
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Letzte Mahlzeit (Std.)
                                        <span class="vital-status">Info</span>
                                    </div>
                                    <input type="number" class="vital-input" id="vitalLastMeal" min="0" max="48" step="0.5">
                                </div>
                                
                                <div class="vital-item">
                                    <div class="vital-label">
                                        Mobilität
                                        <span class="vital-status">Info</span>
                                    </div>
                                    <select class="vital-input" id="vitalMobility" style="text-align: left;">
                                        <option value="">-- Auswählen --</option>
                                        <option value="normal">Normal</option>
                                        <option value="limited">Eingeschränkt</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Medical History Questions -->
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">1. Nehmen Sie regelmäßig Medikamente ein?</div>
                                    <textarea class="answer-input" data-question="med1"></textarea>
                                    <div class="comment-badge" onclick="openComments('med1')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">2. Haben Sie in letzter Zeit Gewichtsab-/Zunahme bemerkt?</div>
                                    <textarea class="answer-input" data-question="med2"></textarea>
                                    <div class="comment-badge" onclick="openComments('med2')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">3. Haben Sie in der Vergangenheit Knochenbrüche, Operationen oder schwere Verletzungen erlitten?</div>
                                    <textarea class="answer-input" data-question="med3"></textarea>
                                    <div class="comment-badge" onclick="openComments('med3')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">4. Wurden Sie jemals ohnmächtig oder haben Sie Bewusstseinsverluste erlebt?</div>
                                    <textarea class="answer-input" data-question="med4"></textarea>
                                    <div class="comment-badge" onclick="openComments('med4')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">5. Haben Sie Probleme mit dem Gleichgewicht, Schwindel oder Koordinationsstörungen?</div>
                                    <textarea class="answer-input" data-question="med5"></textarea>
                                    <div class="comment-badge" onclick="openComments('med5')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">6. Konsumieren Sie Alkohol oder andere psychoaktive Stoffe?</div>
                                    <select class="answer-select" data-question="med6">
                                        <option value="">-- Auswählen --</option>
                                        <option value="never">Nie</option>
                                        <option value="rarely">Selten</option>
                                        <option value="sometimes">Gelegentlich</option>
                                        <option value="regularly">Regelmäßig</option>
                                    </select>
                                    <div class="comment-badge" onclick="openComments('med6')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">7. Wurden Sie jemals wegen Drogen- oder Alkoholmissbrauchs behandelt?</div>
                                    <textarea class="answer-input" data-question="med7"></textarea>
                                    <div class="comment-badge" onclick="openComments('med7')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">8. Gibt es in Ihrer Familie bekannte Suchterkrankungen?</div>
                                    <textarea class="answer-input" data-question="med8"></textarea>
                                    <div class="comment-badge" onclick="openComments('med8')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Allergien / Medikamente:</div>
                                    <textarea class="answer-input" data-question="medAllergies"></textarea>
                                    <div class="comment-badge" onclick="openComments('medAllergies')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Aktuelle Verletzungen / Narben:</div>
                                    <textarea class="answer-input" data-question="medInjuries"></textarea>
                                    <div class="comment-badge" onclick="openComments('medInjuries')">0</div>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Sonstige Auffälligkeiten:</div>
                                    <textarea class="answer-input" data-question="medOther"></textarea>
                                    <div class="comment-badge" onclick="openComments('medOther')">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Vital Parameters Analysis -->
                    <div id="tab3" class="tab-content" style="display: none;">
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-heartbeat"></i> Vitalparameter Analyse
                                </h3>
                                <button onclick="generateVitalAnalysis()" class="btn btn-secondary">
                                    <i class="fas fa-sync"></i> Aktualisieren
                                </button>
                            </div>
                            
                            <div id="vitalAnalysis">
                                <!-- Analysis will be generated here -->
                            </div>
                            
                            <!-- Sportlicher Test -->
                            <div class="section" style="margin-top: 30px;">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-running"></i> Abschnitt 4 – Sportlicher Test
                                    </h3>
                                </div>
                                <div class="question-group">
                                    <div class="question-item">
                                        <div class="question-text">1. 15x Push-Ups (Ergebnis)</div>
                                        <select class="answer-select" data-question="sport1">
                                            <option value="">-- Auswählen --</option>
                                            <option value="completed">Vollständig ausgeführt</option>
                                            <option value="partial">Teilweise ausgeführt</option>
                                            <option value="failed">Nicht ausgeführt</option>
                                        </select>
                                        <div class="comment-badge" onclick="openComments('sport1')">0</div>
                                    </div>
                                    <div class="question-item">
                                        <div class="question-text">2. 10x Sit-Ups (Ergebnis)</div>
                                        <select class="answer-select" data-question="sport2">
                                            <option value="">-- Auswählen --</option>
                                            <option value="completed">Vollständig ausgeführt</option>
                                            <option value="partial">Teilweise ausgeführt</option>
                                            <option value="failed">Nicht ausgeführt</option>
                                        </select>
                                        <div class="comment-badge" onclick="openComments('sport2')">0</div>
                                    </div>
                                    <div class="question-item">
                                        <div class="question-text">3. 10x Burpee (Ergebnis)</div>
                                        <select class="answer-select" data-question="sport3">
                                            <option value="">-- Auswählen --</option>
                                            <option value="completed">Vollständig ausgeführt</option>
                                            <option value="partial">Teilweise ausgeführt</option>
                                            <option value="failed">Nicht ausgeführt</option>
                                        </select>
                                        <div class="comment-badge" onclick="openComments('sport3')">0</div>
                                    </div>
                                    <div class="question-item">
                                        <div class="question-text">4. 2 Runden rennen (Zeit in Minuten)</div>
                                        <input type="number" class="answer-input" data-question="sport4" placeholder="z.B. 8.5">
                                        <div class="comment-badge" onclick="openComments('sport4')">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Situative Fragen -->
                            <div class="section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fas fa-question-circle"></i> Abschnitt 5 – Situative Fragen
                                    </h3>
                                </div>
                                <div class="question-group">
                                    <div class="question-item">
                                        <div class="question-text">1. Waren Sie mit den letzten Einsätzen zufrieden?</div>
                                        <textarea class="answer-input" data-question="sit1"></textarea>
                                        <div class="comment-badge" onclick="openComments('sit1')">0</div>
                                    </div>
                                    <div class="question-item">
                                        <div class="question-text">2. Gibt es bestimmte Situationen im Dienst, die Sie besonders stören?</div>
                                        <textarea class="answer-input" data-question="sit2"></textarea>
                                        <div class="comment-badge" onclick="openComments('sit2')">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 4: Summary -->
                    <div id="tab4" class="tab-content" style="display: none;">
                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-clipboard-check"></i> Zusammenfassung & Empfehlung
                                </h3>
                            </div>
                            <div class="question-group">
                                <div class="question-item">
                                    <div class="question-text">Gesamteindruck des Soldaten</div>
                                    <textarea class="answer-input" id="summaryAssessment" placeholder="Gesamteindruck, Stärken, Schwächen, Auffälligkeiten..."></textarea>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Psychologische Einschätzung</div>
                                    <textarea class="answer-input" id="summaryPsychological" placeholder="Psychologische Bewertung..."></textarea>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Medizinische Einschätzung</div>
                                    <textarea class="answer-input" id="summaryMedical" placeholder="Medizinische Bewertung..."></textarea>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Empfehlung</div>
                                    <select class="answer-select" id="finalRecommendation" style="width: 100%;">
                                        <option value="">-- Empfehlung auswählen --</option>
                                        <option value="fit">Voll einsatzfähig</option>
                                        <option value="limited">Eingeschränkt einsatzfähig</option>
                                        <option value="notfit">Nicht einsatzfähig</option>
                                        <option value="further">Weitere Untersuchung erforderlich</option>
                                        <option value="therapy">Psychologische Betreuung empfohlen</option>
                                        <option value="medical">Medizinische Behandlung erforderlich</option>
                                    </select>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Begründung der Empfehlung</div>
                                    <textarea class="answer-input" id="summaryReason" placeholder="Detaillierte Begründung..."></textarea>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Empfohlene Maßnahmen</div>
                                    <textarea class="answer-input" id="summaryMeasures" placeholder="Empfohlene Maßnahmen, Follow-up Termine..."></textarea>
                                </div>
                                <div class="question-item">
                                    <div class="question-text">Unterschrift des Gutachters</div>
                                    <input type="text" class="answer-input" id="summarySignature" placeholder="Name und Dienstgrad">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comments Modal -->
        <div id="commentModal" class="comment-modal">
            <div class="comment-content">
                <div class="comment-header">
                    <h3 id="commentQuestionTitle"></h3>
                    <button onclick="closeComments()" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="comment-body">
                    <div class="comment-list" id="commentList">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div class="comment-input-area">
                        <textarea id="newComment" class="comment-input" placeholder="Neuen Kommentar hinzufügen..."></textarea>
                        <button onclick="addComment()" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpJhQ9JY4Q2Xq4Q9JY4Q2Xq4Q9JY4Q2Xq4",
            authDomain: "army-medical-system.firebaseapp.com",
            projectId: "army-medical-system",
            storageBucket: "army-medical-system.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // App State
        let currentUser = {
            displayName: "Dr. Miller",
            email: "dr.miller@us.army.mil"
        };
        let currentPatient = null;
        let currentQuestion = null;
        let patients = [];
        let comments = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            setupEventListeners();
            updateExaminerDisplay();
        });

        function updateExaminerDisplay() {
            document.getElementById('currentUser').textContent = `Aktueller Gutachter: ${currentUser.displayName}`;
        }

        function changeExaminer() {
            const name = prompt("Name des Gutachters:", currentUser.displayName);
            const email = prompt("Email des Gutachters:", currentUser.email);
            
            if (name && email) {
                currentUser = {
                    displayName: name,
                    email: email
                };
                updateExaminerDisplay();
                alert(`Gutachter geändert zu: ${name}`);
            }
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', renderPatientList);
            
            // Auto-save on input change
            document.addEventListener('input', debounce(function(e) {
                if (currentPatient && e.target.classList.contains('answer-input')) {
                    autoSave();
                }
            }, 2000));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadPatients() {
            try {
                // In a real app, you would fetch from Firebase
                // For demo, create mock data
                patients = [
                    {
                        id: "PAT-001",
                        firstName: "John",
                        lastName: "Miller",
                        unit: "Delta Force",
                        rank: "Major",
                        status: "completed",
                        createdAt: new Date(),
                        examiner: "Dr. Smith",
                        vitals: {
                            pulse: 72,
                            bpHigh: 125,
                            bpLow: 85,
                            temperature: 36.8,
                            respiration: 16,
                            oxygen: 98,
                            height: 182,
                            weight: 85,
                            fitness: "athletic",
                            lastMeal: 3,
                            mobility: "normal"
                        }
                    },
                    {
                        id: "PAT-002",
                        firstName: "Sarah",
                        lastName: "Connor",
                        unit: "Air Force SpecOps",
                        rank: "Captain",
                        status: "pending",
                        createdAt: new Date(),
                        examiner: "Dr. Miller"
                    },
                    {
                        id: "PAT-003",
                        firstName: "Mike",
                        lastName: "Johnson",
                        unit: "Navy SEALs",
                        rank: "Chief Petty Officer",
                        status: "critical",
                        createdAt: new Date(),
                        examiner: "Dr. Brown"
                    }
                ];
                
                renderPatientList();
            } catch (error) {
                console.error('Error loading patients:', error);
                alert('Fehler beim Laden der Patienten');
            }
        }

        function renderPatientList() {
            const container = document.getElementById('patientList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            container.innerHTML = '';
            
            const filteredPatients = patients.filter(patient => {
                const searchStr = `${patient.firstName} ${patient.lastName} ${patient.unit} ${patient.id} ${patient.rank || ''}`.toLowerCase();
                return searchStr.includes(searchTerm);
            });
            
            if (filteredPatients.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Keine Patienten gefunden</div>';
                return;
            }
            
            filteredPatients.forEach(patient => {
                const card = document.createElement('div');
                card.className = `patient-card ${currentPatient?.id === patient.id ? 'active' : ''}`;
                card.onclick = () => selectPatient(patient);
                
                const statusText = getStatusText(patient.status);
                const statusClass = `status-${patient.status}`;
                
                card.innerHTML = `
                    <div class="patient-id">${patient.id} • ${patient.rank || 'Soldat'}</div>
                    <div class="patient-name">${patient.firstName} ${patient.lastName}</div>
                    <div style="font-size: 13px; color: #ccc;">${patient.unit}</div>
                    <div class="patient-status ${statusClass}" style="margin-top: 8px;">
                        ${statusText}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function selectPatient(patient) {
            currentPatient = patient;
            renderPatientList();
            loadPatientData();
        }

        function loadPatientData() {
            if (!currentPatient) return;
            
            document.getElementById('noPatientSelected').style.display = 'none';
            document.getElementById('patientContent').style.display = 'block';
            
            // Update patient header
            document.getElementById('patientFullName').textContent = `${currentPatient.firstName} ${currentPatient.lastName} (${currentPatient.rank || 'Soldat'})`;
            document.getElementById('patientId').textContent = currentPatient.id;
            document.getElementById('patientUnit').textContent = currentPatient.unit;
            document.getElementById('examinationDate').textContent = new Date(currentPatient.createdAt).toLocaleDateString('de-DE');
            document.getElementById('patientStatus').textContent = getStatusText(currentPatient.status);
            document.getElementById('patientStatus').className = `patient-status status-${currentPatient.status}`;
            
            // Load vitals if available
            if (currentPatient.vitals) {
                const v = currentPatient.vitals;
                document.getElementById('vitalPulse').value = v.pulse || '';
                document.getElementById('vitalBpHigh').value = v.bpHigh || '';
                document.getElementById('vitalBpLow').value = v.bpLow || '';
                document.getElementById('vitalTemp').value = v.temperature || '';
                document.getElementById('vitalRespiration').value = v.respiration || '';
                document.getElementById('vitalOxygen').value = v.oxygen || '';
                document.getElementById('vitalHeight').value = v.height || '';
                document.getElementById('vitalWeight').value = v.weight || '';
                document.getElementById('vitalFitness').value = v.fitness || '';
                document.getElementById('vitalLastMeal').value = v.lastMeal || '';
                document.getElementById('vitalMobility').value = v.mobility || '';
                
                updateVitalStatus('pulse');
                updateVitalStatus('bp');
                updateVitalStatus('temp');
                updateVitalStatus('resp');
                updateVitalStatus('oxygen');
                calculateBMI();
            }
            
            // Load answers if available
            if (currentPatient.answers) {
                Object.keys(currentPatient.answers).forEach(key => {
                    const input = document.querySelector(`[data-question="${key}"]`);
                    if (input) input.value = currentPatient.answers[key];
                });
            }
            
            // Load summary if available
            if (currentPatient.summary) {
                document.getElementById('summaryAssessment').value = currentPatient.summary.assessment || '';
                document.getElementById('summaryPsychological').value = currentPatient.summary.psychological || '';
                document.getElementById('summaryMedical').value = currentPatient.summary.medical || '';
                document.getElementById('finalRecommendation').value = currentPatient.summary.recommendation || '';
                document.getElementById('summaryReason').value = currentPatient.summary.reason || '';
                document.getElementById('summaryMeasures').value = currentPatient.summary.measures || '';
                document.getElementById('summarySignature').value = currentPatient.summary.signature || '';
            }
            
            // Load comments if available
            if (currentPatient.comments) {
                comments = currentPatient.comments;
                updateCommentBadges();
            }
            
            // Generate initial analysis
            generateVitalAnalysis();
        }

        async function createNewPatient() {
            const firstName = prompt('Vorname des Soldaten:');
            const lastName = prompt('Nachname des Soldaten:');
            const rank = prompt('Dienstgrad:', 'Soldat');
            const unit = prompt('Einheit:');
            
            if (!firstName || !lastName || !unit) {
                alert('Bitte alle erforderlichen Felder ausfüllen');
                return;
            }
            
            const patientId = 'PAT-' + Date.now().toString().slice(-6);
            
            const patientData = {
                id: patientId,
                firstName: firstName,
                lastName: lastName,
                rank: rank || 'Soldat',
                unit: unit,
                status: 'pending',
                createdAt: new Date(),
                examiner: currentUser.displayName,
                examinerEmail: currentUser.email,
                answers: {},
                vitals: {},
                comments: {},
                summary: {}
            };
            
            try {
                // In a real app, save to Firebase
                // await db.collection('patients').add(patientData);
                
                patients.unshift(patientData);
                renderPatientList();
                selectPatient(patientData);
                
                alert(`Neue Untersuchung für ${firstName} ${lastName} (${rank}) erstellt`);
            } catch (error) {
                console.error('Error creating patient:', error);
                alert('Fehler beim Erstellen der Untersuchung');
            }
        }

        async function savePatient() {
            if (!currentPatient) return;
            
            try {
                // Collect all answers
                const answers = {};
                document.querySelectorAll('.answer-input, .answer-select').forEach(input => {
                    const questionId = input.getAttribute('data-question');
                    if (questionId && input.value) {
                        answers[questionId] = input.value;
                    }
                });
                
                // Collect vitals
                const vitals = {
                    pulse: document.getElementById('vitalPulse').value,
                    bpHigh: document.getElementById('vitalBpHigh').value,
                    bpLow: document.getElementById('vitalBpLow').value,
                    temperature: document.getElementById('vitalTemp').value,
                    respiration: document.getElementById('vitalRespiration').value,
                    oxygen: document.getElementById('vitalOxygen').value,
                    height: document.getElementById('vitalHeight').value,
                    weight: document.getElementById('vitalWeight').value,
                    fitness: document.getElementById('vitalFitness').value,
                    lastMeal: document.getElementById('vitalLastMeal').value,
                    mobility: document.getElementById('vitalMobility').value,
                    bmi: document.getElementById('vitalBMI').value
                };
                
                // Collect summary
                const summary = {
                    assessment: document.getElementById('summaryAssessment').value,
                    psychological: document.getElementById('summaryPsychological').value,
                    medical: document.getElementById('summaryMedical').value,
                    recommendation: document.getElementById('finalRecommendation').value,
                    reason: document.getElementById('summaryReason').value,
                    measures: document.getElementById('summaryMeasures').value,
                    signature: document.getElementById('summarySignature').value || currentUser.displayName
                };
                
                // Update patient data
                currentPatient.answers = answers;
                currentPatient.vitals = vitals;
                currentPatient.summary = summary;
                currentPatient.comments = comments;
                currentPatient.examiner = currentUser.displayName;
                currentPatient.examinerEmail = currentUser.email;
                currentPatient.updatedAt = new Date();
                
                // Update status based on recommendation
                if (summary.recommendation === 'fit') currentPatient.status = 'completed';
                else if (summary.recommendation === 'notfit') currentPatient.status = 'critical';
                else currentPatient.status = 'pending';
                
                // In a real app, save to Firebase
                // await db.collection('patients').doc(currentPatient.id).update({
                //     answers: answers,
                //     vitals: vitals,
                //     summary: summary,
                //     comments: comments,
                //     examiner: currentUser.displayName,
                //     examinerEmail: currentUser.email,
                //     status: currentPatient.status,
                //     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                // });
                
                // Update UI
                document.getElementById('patientStatus').textContent = getStatusText(currentPatient.status);
                document.getElementById('patientStatus').className = `patient-status status-${currentPatient.status}`;
                
                // Show success message
                const saveBtn = document.querySelector('.btn-primary');
                const originalHTML = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Gespeichert';
                saveBtn.style.background = 'var(--success)';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalHTML;
                    saveBtn.style.background = '';
                }, 2000);
                
                // Refresh patient list
                renderPatientList();
                
            } catch (error) {
                console.error('Error saving patient:', error);
                alert('Fehler beim Speichern der Daten');
            }
        }

        function autoSave() {
            if (!currentPatient) return;
            
            // Only save answers in auto-save mode
            const answers = {};
            document.querySelectorAll('.answer-input, .answer-select').forEach(input => {
                const questionId = input.getAttribute('data-question');
                if (questionId && input.value) {
                    answers[questionId] = input.value;
                }
            });
            
            currentPatient.answers = answers;
            
            // Show auto-save indicator
            const saveBtn = document.querySelector('.btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Speichern...';
            
            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Speichern';
            }, 500);
        }

        function updateVitalStatus(type) {
            // Pulse
            const pulse = parseFloat(document.getElementById('vitalPulse').value);
            const pulseStatus = document.getElementById('pulseStatus');
            if (pulse) {
                if (pulse >= 60 && pulse <= 100) {
                    pulseStatus.textContent = 'Normal';
                    pulseStatus.className = 'vital-status status-normal';
                } else if (pulse < 60) {
                    pulseStatus.textContent = 'Niedrig';
                    pulseStatus.className = 'vital-status status-warning';
                } else {
                    pulseStatus.textContent = 'Hoch';
                    pulseStatus.className = 'vital-status status-danger';
                }
            } else {
                pulseStatus.textContent = 'Normal';
                pulseStatus.className = 'vital-status status-normal';
            }
            
            // Blood Pressure
            const bpHigh = parseFloat(document.getElementById('vitalBpHigh').value);
            const bpLow = parseFloat(document.getElementById('vitalBpLow').value);
            const bpStatus = document.getElementById('bpStatus');
            if (bpHigh && bpLow) {
                if (bpHigh >= 110 && bpHigh <= 140 && bpLow >= 60 && bpLow <= 90) {
                    bpStatus.textContent = 'Normal';
                    bpStatus.className = 'vital-status status-normal';
                } else if (bpHigh < 110 || bpLow < 60) {
                    bpStatus.textContent = 'Niedrig';
                    bpStatus.className = 'vital-status status-warning';
                } else {
                    bpStatus.textContent = 'Hoch';
                    bpStatus.className = 'vital-status status-danger';
                }
            } else {
                bpStatus.textContent = 'Normal';
                bpStatus.className = 'vital-status status-normal';
            }
            
            // Temperature
            const temp = parseFloat(document.getElementById('vitalTemp').value);
            const tempStatus = document.getElementById('tempStatus');
            if (temp) {
                if (temp >= 36.1 && temp <= 37.5) {
                    tempStatus.textContent = 'Normal';
                    tempStatus.className = 'vital-status status-normal';
                } else if (temp < 36) {
                    tempStatus.textContent = 'Unterkühlt';
                    tempStatus.className = 'vital-status status-warning';
                } else {
                    tempStatus.textContent = 'Fieber';
                    tempStatus.className = 'vital-status status-danger';
                }
            } else {
                tempStatus.textContent = 'Normal';
                tempStatus.className = 'vital-status status-normal';
            }
            
            // Respiration
            const resp = parseFloat(document.getElementById('vitalRespiration').value);
            const respStatus = document.getElementById('respStatus');
            if (resp) {
                if (resp >= 12 && resp <= 20) {
                    respStatus.textContent = 'Normal';
                    respStatus.className = 'vital-status status-normal';
                } else if (resp < 12) {
                    respStatus.textContent = 'Langsam';
                    respStatus.className = 'vital-status status-warning';
                } else {
                    respStatus.textContent = 'Schnell';
                    respStatus.className = 'vital-status status-danger';
                }
            } else {
                respStatus.textContent = 'Normal';
                respStatus.className = 'vital-status status-normal';
            }
            
            // Oxygen
            const oxygen = parseFloat(document.getElementById('vitalOxygen').value);
            const oxygenStatus = document.getElementById('oxygenStatus');
            if (oxygen) {
                if (oxygen >= 95 && oxygen <= 100) {
                    oxygenStatus.textContent = 'Normal';
                    oxygenStatus.className = 'vital-status status-normal';
                } else if (oxygen >= 90 && oxygen < 95) {
                    oxygenStatus.textContent = 'Gering';
                    oxygenStatus.className = 'vital-status status-warning';
                } else if (oxygen < 90) {
                    oxygenStatus.textContent = 'Kritisch';
                    oxygenStatus.className = 'vital-status status-danger';
                }
            } else {
                oxygenStatus.textContent = 'Normal';
                oxygenStatus.className = 'vital-status status-normal';
            }
        }

        function calculateBMI() {
            const height = parseFloat(document.getElementById('vitalHeight').value) / 100; // Convert to meters
            const weight = parseFloat(document.getElementById('vitalWeight').value);
            const bmiStatus = document.getElementById('bmiStatus');
            
            if (height && weight && height > 0) {
                const bmi = weight / (height * height);
                document.getElementById('vitalBMI').value = bmi.toFixed(1);
                
                if (bmi < 18.5) {
                    bmiStatus.textContent = 'Untergewicht';
                    bmiStatus.className = 'vital-status status-warning';
                } else if (bmi >= 18.5 && bmi <= 24.9) {
                    bmiStatus.textContent = 'Normal';
                    bmiStatus.className = 'vital-status status-normal';
                } else if (bmi >= 25 && bmi <= 29.9) {
                    bmiStatus.textContent = 'Übergewicht';
                    bmiStatus.className = 'vital-status status-warning';
                } else {
                    bmiStatus.textContent = 'Adipositas';
                    bmiStatus.className = 'vital-status status-danger';
                }
            } else {
                document.getElementById('vitalBMI').value = '';
                bmiStatus.textContent = 'Berechnen';
                bmiStatus.className = 'vital-status';
            }
        }

        function generateVitalAnalysis() {
            const analysisDiv = document.getElementById('vitalAnalysis');
            
            // Get current values
            const pulse = document.getElementById('vitalPulse').value;
            const bpHigh = document.getElementById('vitalBpHigh').value;
            const bpLow = document.getElementById('vitalBpLow').value;
            const temp = document.getElementById('vitalTemp').value;
            const resp = document.getElementById('vitalRespiration').value;
            const oxygen = document.getElementById('vitalOxygen').value;
            const height = document.getElementById('vitalHeight').value;
            const weight = document.getElementById('vitalWeight').value;
            const bmi = document.getElementById('vitalBMI').value;
            const fitness = document.getElementById('vitalFitness').value;
            const lastMeal = document.getElementById('vitalLastMeal').value;
            const mobility = document.getElementById('vitalMobility').value;
            
            let analysisHTML = `
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Wert</th>
                            <th>Normalwert</th>
                            <th>Bewertung</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Helper function to get status
            function getStatus(value, min, max) {
                if (!value) return {text: 'Nicht gemessen', class: ''};
                const numValue = parseFloat(value);
                if (numValue >= min && numValue <= max) {
                    return {text: 'Normal', class: 'status-normal'};
                } else if (numValue < min) {
                    return {text: 'Unter Norm', class: 'status-warning'};
                } else {
                    return {text: 'Über Norm', class: 'status-danger'};
                }
            }
            
            // Add rows for each parameter
            const params = [
                {name: 'Puls', value: pulse, unit: 'bpm', min: 60, max: 100},
                {name: 'Blutdruck', value: bpHigh && bpLow ? `${bpHigh}/${bpLow}` : '', unit: 'mmHg', min: '110/60', max: '140/90'},
                {name: 'Körpertemperatur', value: temp, unit: '°C', min: 36.1, max: 37.5},
                {name: 'Atemfrequenz', value: resp, unit: '/min', min: 12, max: 20},
                {name: 'Sauerstoffsättigung', value: oxygen, unit: '%', min: 95, max: 100}
            ];
            
            params.forEach(param => {
                let status;
                if (param.name === 'Blutdruck') {
                    if (bpHigh && bpLow) {
                        const high = parseFloat(bpHigh);
                        const low = parseFloat(bpLow);
                        if (high >= 110 && high <= 140 && low >= 60 && low <= 90) {
                            status = {text: 'Normal', class: 'status-normal'};
                        } else if (high < 110 || low < 60) {
                            status = {text: 'Niedrig', class: 'status-warning'};
                        } else {
                            status = {text: 'Hoch', class: 'status-danger'};
                        }
                    } else {
                        status = {text: 'Nicht gemessen', class: ''};
                    }
                } else {
                    status = getStatus(param.value, param.min, param.max);
                }
                
                analysisHTML += `
                    <tr>
                        <td>${param.name}</td>
                        <td>${param.value || '-'} ${param.value ? param.unit : ''}</td>
                        <td>${param.min} - ${param.max} ${param.unit || ''}</td>
                        <td><span class="patient-status ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            });
            
            // Add BMI row
            if (bmi) {
                let bmiStatus;
                const bmiNum = parseFloat(bmi);
                if (bmiNum < 18.5) bmiStatus = {text: 'Untergewicht', class: 'status-warning'};
                else if (bmiNum >= 18.5 && bmiNum <= 24.9) bmiStatus = {text: 'Normal', class: 'status-normal'};
                else if (bmiNum >= 25 && bmiNum <= 29.9) bmiStatus = {text: 'Übergewicht', class: 'status-warning'};
                else bmiStatus = {text: 'Adipositas', class: 'status-danger'};
                
                analysisHTML += `
                    <tr>
                        <td>BMI</td>
                        <td>${bmi}</td>
                        <td>18.5 - 24.9</td>
                        <td><span class="patient-status ${bmiStatus.class}">${bmiStatus.text}</span></td>
                    </tr>
                `;
            }
            
            // Add fitness row
            if (fitness) {
                const fitnessText = {
                    athletic: 'Sportlich',
                    average: 'Durchschnittlich',
                    weak: 'Schwach'
                }[fitness] || fitness;
                
                analysisHTML += `
                    <tr>
                        <td>Fitness-Eindruck</td>
                        <td>${fitnessText}</td>
                        <td>-</td>
                        <td><span class="patient-status status-info">Subjektiv</span></td>
                    </tr>
                `;
            }
            
            // Add last meal row
            if (lastMeal) {
                let mealStatus;
                const hours = parseFloat(lastMeal);
                if (hours <= 6) mealStatus = {text: 'Normal', class: 'status-normal'};
                else if (hours <= 12) mealStatus = {text: 'Lange Pause', class: 'status-warning'};
                else mealStatus = {text: 'Fastend', class: 'status-danger'};
                
                analysisHTML += `
                    <tr>
                        <td>Letzte Mahlzeit</td>
                        <td>${lastMeal} Stunden</td>
                        <td>0 - 6 Stunden</td>
                        <td><span class="patient-status ${mealStatus.class}">${mealStatus.text}</span></td>
                    </tr>
                `;
            }
            
            // Add mobility row
            if (mobility) {
                const mobilityText = {
                    normal: 'Normal',
                    limited: 'Eingeschränkt'
                }[mobility] || mobility;
                
                const mobilityStatus = mobility === 'normal' ? 
                    {text: 'Normal', class: 'status-normal'} : 
                    {text: 'Eingeschränkt', class: 'status-warning'};
                
                analysisHTML += `
                    <tr>
                        <td>Mobilität</td>
                        <td>${mobilityText}</td>
                        <td>Normal</td>
                        <td><span class="patient-status ${mobilityStatus.class}">${mobilityStatus.text}</span></td>
                    </tr>
                `;
            }
            
            analysisHTML += `
                    </tbody>
                </table>
            `;
            
            // Add summary
            analysisHTML += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <h4 style="color: var(--army-tan); margin-bottom: 10px;">Zusammenfassung:</h4>
            `;
            
            // Count abnormal values
            const abnormalCount = document.querySelectorAll('.vital-status.status-warning, .vital-status.status-danger').length;
            
            if (abnormalCount === 0) {
                analysisHTML += `<p>✅ Alle Vitalparameter im Normalbereich. Keine medizinischen Bedenken.</p>`;
            } else if (abnormalCount <= 2) {
                analysisHTML += `<p>⚠️ ${abnormalCount} Parameter außerhalb des Normbereichs. Weitere Beobachtung empfohlen.</p>`;
            } else {
                analysisHTML += `<p>🚨 ${abnormalCount} Parameter außerhalb des Normbereichs. Dringende medizinische Untersuchung empfohlen.</p>`;
            }
            
            analysisHTML += `</div>`;
            
            analysisDiv.innerHTML = analysisHTML;
        }

        // Comments System
        function openComments(questionId) {
            currentQuestion = questionId;
            
            // Set modal title
            const questionText = document.querySelector(`[data-question="${questionId}"]`)?.closest('.question-item')?.querySelector('.question-text')?.textContent;
            document.getElementById('commentQuestionTitle').textContent = questionText || `Frage ${questionId}`;
            
            // Load comments
            loadComments();
            
            // Show modal
            document.getElementById('commentModal').classList.add('active');
        }

        function closeComments() {
            document.getElementById('commentModal').classList.remove('active');
            currentQuestion = null;
            document.getElementById('newComment').value = '';
        }

        function loadComments() {
            if (!currentPatient || !currentQuestion) return;
            
            const commentList = document.getElementById('commentList');
            
            // Get comments for this question
            const questionComments = comments[currentQuestion] || [];
            
            if (questionComments.length === 0) {
                commentList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Keine Kommentare</div>';
                return;
            }
            
            commentList.innerHTML = '';
            questionComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <div class="comment-author">
                        <span>${comment.author}</span>
                        <span style="font-size: 12px; color: #999;">${new Date(comment.timestamp).toLocaleString('de-DE')}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                `;
                commentList.appendChild(commentDiv);
            });
            
            // Update badge
            updateCommentBadge(currentQuestion, questionComments.length);
        }

        function addComment() {
            if (!currentPatient || !currentQuestion) return;
            
            const commentText = document.getElementById('newComment').value.trim();
            if (!commentText) return;
            
            // Initialize comments array if needed
            if (!comments[currentQuestion]) {
                comments[currentQuestion] = [];
            }
            
            // Add new comment
            const newComment = {
                text: commentText,
                author: currentUser.displayName,
                timestamp: new Date().toISOString()
            };
            
            comments[currentQuestion].push(newComment);
            
            // Clear input
            document.getElementById('newComment').value = '';
            
            // Reload comments
            loadComments();
            
            // Auto-save patient
            if (currentPatient) {
                currentPatient.comments = comments;
                autoSave();
            }
        }

        function updateCommentBadges() {
            Object.keys(comments).forEach(questionId => {
                const questionComments = comments[questionId] || [];
                updateCommentBadge(questionId, questionComments.length);
            });
        }

        function updateCommentBadge(questionId, count) {
            const badge = document.querySelector(`[data-question="${questionId}"]`)?.closest('.question-item')?.querySelector('.comment-badge');
            if (badge) {
                badge.textContent = count;
                badge.classList.toggle('has-comment', count > 0);
            }
        }

        function switchTab(tabNumber) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab${tabNumber}`).style.display = 'block';
            
            // Add active class to selected tab
            document.querySelectorAll('.tab')[tabNumber - 1].classList.add('active');
            
            // If switching to tab 3, generate analysis
            if (tabNumber === 3) {
                generateVitalAnalysis();
            }
        }

        function printReport() {
            if (!currentPatient) {
                alert('Bitte zuerst einen Patienten auswählen');
                return;
            }
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medizinisches Gutachten - ${currentPatient.firstName} ${currentPatient.lastName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .section { margin-bottom: 30px; page-break-inside: avoid; }
                        .section-title { background: #f0f0f0; padding: 10px; font-weight: bold; border-left: 4px solid #4d774e; }
                        .question { margin: 15px 0; }
                        .question-text { font-weight: bold; color: #333; }
                        .answer { margin-left: 20px; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .signature { margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>U.S. ARMY - Medizinisches Gutachten</h1>
                        <h2>${currentPatient.firstName} ${currentPatient.lastName} - ${currentPatient.rank || 'Soldat'}</h2>
                        <p><strong>Einheit:</strong> ${currentPatient.unit}</p>
                        <p><strong>Untersuchungsdatum:</strong> ${new Date(currentPatient.createdAt).toLocaleDateString('de-DE')}</p>
                        <p><strong>Gutachter:</strong> ${currentUser.displayName}</p>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Zusammenfassung & Empfehlung</h3>
                        <p><strong>Gesamteindruck:</strong><br>${document.getElementById('summaryAssessment').value || 'Nicht bewertet'}</p>
                        <p><strong>Psychologische Einschätzung:</strong><br>${document.getElementById('summaryPsychological').value || 'Nicht bewertet'}</p>
                        <p><strong>Medizinische Einschätzung:</strong><br>${document.getElementById('summaryMedical').value || 'Nicht bewertet'}</p>
                        <p><strong>Empfehlung:</strong> ${document.getElementById('finalRecommendation').selectedOptions[0]?.text || 'Nicht ausgewählt'}</p>
                        <p><strong>Begründung:</strong><br>${document.getElementById('summaryReason').value || ''}</p>
                        <p><strong>Empfohlene Maßnahmen:</strong><br>${document.getElementById('summaryMeasures').value || ''}</p>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Vitalparameter</h3>
                        <table>
                            <tr><th>Parameter</th><th>Wert</th><th>Normalwert</th></tr>
                            <tr><td>Puls</td><td>${document.getElementById('vitalPulse').value || '-'} bpm</td><td>60-100 bpm</td></tr>
                            <tr><td>Blutdruck</td><td>${document.getElementById('vitalBpHigh').value || '-'}/${document.getElementById('vitalBpLow').value || '-'} mmHg</td><td>110-140/60-90 mmHg</td></tr>
                            <tr><td>Körpertemperatur</td><td>${document.getElementById('vitalTemp').value || '-'} °C</td><td>36.1-37.5 °C</td></tr>
                            <tr><td>Atemfrequenz</td><td>${document.getElementById('vitalRespiration').value || '-'} /min</td><td>12-20 /min</td></tr>
                            <tr><td>Sauerstoffsättigung</td><td>${document.getElementById('vitalOxygen').value || '-'} %</td><td>95-100%</td></tr>
                            <tr><td>BMI</td><td>${document.getElementById('vitalBMI').value || '-'}</td><td>18.5-24.9</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Psychologische Bewertung</h3>
                        ${getPsychologicalSummary()}
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Medizinische Bewertung</h3>
                        ${getMedicalSummary()}
                    </div>
                    
                    <div class="signature">
                        <p>Unterschrift Gutachter: _________________________</p>
                        <p>Datum: ${new Date().toLocaleDateString('de-DE')}</p>
                    </div>
                    
                    <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; right: 20px; padding: 10px; background: #4d774e; color: white; border: none; cursor: pointer;">
                        Bericht drucken
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function getPsychologicalSummary() {
            let summary = '';
            const sections = ['1.1', '1.2', '1.3', '2.1', '2.2', '2.3', '2.4', '3.1', '3.2', '3.3', '3.4', '3.5', '4.1', '4.2', '4.3', '4.4', '5.1', '5.2', '5.3', '5.4', '6.1', '6.2', '6.3', '6.4', '6.5'];
            
            sections.forEach(qId => {
                const input = document.querySelector(`[data-question="${qId}"]`);
                if (input && input.value) {
                    const questionText = input.closest('.question-item')?.querySelector('.question-text')?.textContent;
                    if (questionText) {
                        summary += `<p><strong>${questionText}</strong><br>${input.value}</p>`;
                    }
                }
            });
            
            return summary || '<p>Keine psychologischen Daten erfasst.</p>';
        }

        function getMedicalSummary() {
            let summary = '';
            const sections = ['med1', 'med2', 'med3', 'med4', 'med5', 'med6', 'med7', 'med8', 'medAllergies', 'medInjuries', 'medOther'];
            
            sections.forEach(qId => {
                const input = document.querySelector(`[data-question="${qId}"]`);
                if (input && input.value) {
                    const questionText = input.closest('.question-item')?.querySelector('.question-text')?.textContent;
                    if (questionText) {
                        summary += `<p><strong>${questionText}</strong><br>${input.value}</p>`;
                    }
                }
            });
            
            return summary || '<p>Keine medizinischen Daten erfasst.</p>';
        }

        function deletePatient() {
            if (!currentPatient) return;
            
            if (confirm(`Sind Sie sicher, dass Sie die Untersuchung von ${currentPatient.firstName} ${currentPatient.lastName} löschen möchten?`)) {
                // Remove from array
                const index = patients.findIndex(p => p.id === currentPatient.id);
                if (index !== -1) {
                    patients.splice(index, 1);
                }
                
                // Reset view
                currentPatient = null;
                document.getElementById('noPatientSelected').style.display = 'block';
                document.getElementById('patientContent').style.display = 'none';
                
                // Refresh list
                renderPatientList();
                
                alert('Untersuchung gelöscht');
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'In Bearbeitung',
                'completed': 'Abgeschlossen',
                'critical': 'Kritisch'
            };
            return statusMap[status] || status;
        }
    </script>
</body>
</html>
